---
# Add Cognos Analytics 11.2.x application to an existing MAS Core 8.10.x + CP4D 4.6.x installation
#
# Dependencies:
# - ansible-playbook ibm.mas_devops.oneclick_core
# - ansible-playbook ibm.mas_devops.oneclick_manage
#
#
- hosts: localhost
  any_errors_fatal: true

  vars:
    # Application Installation
    # -------------------------------------------------------------------------
    mas_app_id: "{{ lookup('env', 'MAS_APP_ID') | default('manage', true) }}"
    mas_app_channel: "{{ lookup('env', 'MAS_APP_CHANNEL') | default('8.10.x', true) }}"

    # Application Configuration
    # -------------------------------------------------------------------------
    mas_workspace_id: "{{ lookup('env', 'MAS_WORKSPACE_ID') | default('masdev', true) }}"

    # Cloud Pak for Data Configuration
    # -------------------------------------------------------------------------
    cpd_product_version: "{{ lookup('env', 'CPD_PRODUCT_VERSION') | default('4.6.0', true) }}"

    # these vars will be set by cp4d playbook, if it did not run (eg install_cp4d_platform=false), it will be set by the environment vars.
    cpd_url: "{{ lookup('env', 'CPD_URL') }}"
    cpd_admin_username: "{{ lookup('env', 'CPD_ADMIN_USERNAME') }}"
    cpd_admin_password: "{{ lookup('env', 'CPD_ADMIN_PASSWORD') }}"

    # Control what elements of CPD are installed
    install_cp4d_platform: "{{ lookup('env', 'CP4D_INSTALL_PLATFORM') | default('True', true) | bool }}"

  pre_tasks:
    - include_role:
      # Cloud Pak for Data Platform (~1 1/2 hours)
        name: ibm.mas_devops.cp4d
      when: install_cp4d_platform == true
    - include_role:
      # Watson Studio (~3 hours)
        name: ibm.mas_devops.cp4d_service
      vars:
        cpd_service_name: cognos_analytics

    # For the full set of supported environment variables refer to the playbook documentation
    - name: Check for required environment variables
      assert:
        that:
          - lookup('env', 'MAS_INSTANCE_ID') != ""
          - lookup('env', 'IBM_ENTITLEMENT_KEY') != ""
          - cpd_url != ""
          - cpd_admin_username != ""
          - cpd_admin_password != ""
        fail_msg: "One or more required environment variables are not defined"
