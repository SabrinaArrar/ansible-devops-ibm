- name: "Restore Monitor"
  hosts: localhost
  any_errors_fatal: true

  pre_tasks:
    # Check for required environment variables
    # -------------------------------------------------------------------------
    - name: "Get required environment variables"
      set_fact:
        mas_instance_id: "{{ lookup('env', 'MAS_INSTANCE_ID') }}"
        mas_workspace_id: "{{ lookup('env', 'MAS_WORKSPACE_ID') }}"
        db2_instance_id: "{{ lookup('env', 'DB2_INSTANCE_NAME') }}"

    - name: "Fail if mas_instance_id is not provided"
      assert:
        that: mas_instance_id is defined and mas_instance_id != ""
        fail_msg: "mas_instance_id is required"

    - name: "Fail if mas_workspace_id is not provided"
      assert:
        that: mas_workspace_id is defined and mas_workspace_id != ""
        fail_msg: "mas_workspace_id is required"

    - name: "Fail if db2_instance_id is not provided"
      assert:
        that: db2_instance_id is defined and db2_instance_id != ""
        fail_msg: "db2_instance_id is required"


    # Set job variables
    # -------------------------------------------------------------------------
    - name: "Set fact: restore job variables"
      set_fact:
        masbr_job_version: "{{ '%Y%m%d%H%M%S' | strftime }}"
        masbr_job_component:
          name: "monitor"
          instance: "{{ mas_instance_id }}"
          namespace: "mas-{{ mas_instance_id }}-monitor"


    # Common checks before run tasks
    # -------------------------------------------------------------------------
    - name: "Set fact: override role_path based on playbook_dir"
      set_fact:
        role_path: "{{ [playbook_dir, '../common_tasks/backup_restore'] | path_join }}"

    - name: "Debug: role_path"
      debug:
        var: role_path

    - name: "Before run tasks"
      include_tasks: "{{ role_path }}/../../common_tasks/backup_restore/before_run_tasks.yml"
      vars:
        _job_type: "restore"

  tasks:
    # Create k8s Job to run restore tasks
    # -------------------------------------------------------------------------
    - name: "Create k8s Job to run restore tasks"
      when: masbr_create_task_job
      include_tasks: "{{ role_path }}/../../common_tasks/backup_restore/create_run_tasks_job.yml"
      vars:
        _rt_playbook_name: "backup_core"
        _rt_env:
          - name: "MAS_INSTANCE_ID"
            value: "{{ mas_instance_id }}"
          - name: "MAS_WORKSPACE_ID"
            value: "{{ mas_workspace_id }}"
          - name: "DB2_INSTANCE_NAME"
            value: "{{ db2_instance_id }}"


    # Run restore tasks in k8s Job or local workstation
    # -------------------------------------------------------------------------
    - name: "Run restore tasks"
      when: not masbr_create_task_job
      block:
        - name: "Restore MongoDB"
          include_role:
            name: ibm.mas_devops.mongodb
          vars:
            mongodb_action: "restore"
            mas_app_id: "monitor"

        - name: "Restore Db2"
          include_role:
            name: ibm.mas_devops.db2
          vars:
            db2_action: "restore"

        - name: "Restore MAS Core namespace"
          include_role:
            name: ibm.mas_devops.suite_backup_restore
          vars:
            masbr_action: "restore"

        - name: "Restore IoT namespace"
          include_role:
            name: ibm.mas_devops.suite_app_backup_restore
          vars:
            masbr_action: "restore"
            mas_app_id: "iot"

        - name: "Restore Monitor namespace"
          include_role:
            name: ibm.mas_devops.suite_app_backup_restore
          vars:
            masbr_action: "restore"
            mas_app_id: "monitor"
