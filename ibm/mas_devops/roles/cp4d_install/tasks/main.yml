---
- set_fact:
    mas87_channels: "{{ mas87_default_channels }}"

# 0. Check for undefined properties that do not have a default
# -----------------------------------------------------------------------------
# - fail if neither cpd_version nor mas_channel provided, as we need something to determine which cpd version to be installed.
- name: "Fail if cpd_version and mas_channel are not provided"
  when:
    - cpd_version is not defined or cpd_version == ''
    - mas_channel is not defined or mas_channel == ''
  fail:
    msg: "either cpd_version or mas_channel properties are required"


# 1. Check for CPD supported versions
# -----------------------------------------------------------------------------
# - fail if neither cpd_version nor mas_channel provided, as we need something to determine which cpd version to be installed.
- name: "Fail if defined cpd_version is not supported"
  vars:
    cpd_supported_versions: "{{ cpd_default_supported_versions }}"
  when:
    - cpd_version is defined and cpd_version != ''
    - cpd_version not in cpd_supported_versions
  fail:
    msg: "cpd_version {{ cpd_version }} is not supported. cpd_versions supported are {{ cpd_supported_versions }}"


# 2. Check if CPD version is compatible with MAS version to be installed (if any)
# -----------------------------------------------------------------------------
# - fail when MAS 8.7 installed not installed with cpd_version = 4.0
# - fail when MAS 8.6 and below not installed with cpd_version = 3.5
- name: "Fail if cpd_version not compatible with mas_channel"
  when:
    - mas_channel is defined
    - mas_channel !=''
    - (cpd_version == 'cpd35' and (mas_channel in mas87_channels)) or (cpd_version == 'cpd40' and (mas_channel not in mas87_channels))

  fail:
    msg: "cpd_version {{ cpd_version }} is not compatible with mas_channel {{ mas_channel }}"


# 3. Check which CPD version to install
# -----------------------------------------------------------------------------
# - if cpd_version not provided, then use mas_channel to determine which cpd version is compatible
- name: Check CP4D version to be installed
  when:
    - cpd_version is not defined or cpd_version == ''
  set_fact:
    cpd_version: "{{ 'cpd40' if (mas_channel in mas87_channels) else 'cpd35' }}"


- debug:
    msg:
      - "CPD Version to be installed: {{ cpd_version }}"
      - "MAS Channel: {{ 'Unspecified' if (mas_channel is not defined or mas_channel == '') else mas_channel }}"

- include_tasks: "tasks/{{ cpd_version }}/cpd-install.yml"
