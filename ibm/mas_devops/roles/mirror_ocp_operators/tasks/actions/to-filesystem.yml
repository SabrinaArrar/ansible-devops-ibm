---
# 1. Check for undefined properties that do not have a default
# -----------------------------------------------------------------------------
- name: "{{ catalog_index }} : Fail if required properties are not provided"
  assert:
    that:
      - openshift_operators_version is defined and openshift_operators_version != ""
      - redhat_pullsecret is defined and redhat_pullsecret != ""
      - mirror_working_dir is defined and mirror_working_dir != ""
    fail_msg: "One or more required properties are missing"


# 2. Perform Mirroring
# -----------------------------------------------------------------------------
- name: "{{ catalog_index }} : Generate Operator Index Manifest (to filesystem)"
  shell: >
    oc adm catalog mirror registry.redhat.io/redhat/{{ catalog_index }}:v{{ openshift_operators_version }} file://redhat/{{ catalog_index }} \
      -a {{ redhat_pullsecret }} \
      --dir={{ mirror_working_dir }} \
      --index-filter-by-os='linux/amd64' \
      --manifests-only \
      --to-manifests={{ mirror_working_dir }}/manifests/to-filesystem
  register: mirror_result

- name: "{{ catalog_index }} : Remove any previous broken down manifests"
  file:
    path: "{{ item }}"
    state: absent
  with_fileglob: "{{ mirror_working_dir }}/manifests/to-filesystem/mapping_*"

- name: "{{ catalog_index }} : Break up the manifest into 100 package chunks"
  shell: >
    split -l 100 {{ mirror_working_dir }}/manifests/to-filesystem/mapping.txt {{ mirror_working_dir }}/manifests/to-filesystem/mapping_
  register: split_result

# Not happy about it, but we have to use --continue-on-error because of the way Red Hat does things,
# there are unusable items in their catalogs.
#
# We can't differentiate between an expected error and an actual error, which is terrible given the likelyhood
# of unexpected errors when mirroring such large amounts of images.
- name: "Process each chunk of the manifest"
  shell: >
    name=$(basename {{item}})
    oc image mirror \
      -a {{ redhat_pullsecret }} \
      --dir={{ mirror_working_dir }} \
      --keep-manifest-list=true \
      -f {{ item }} \
      --continue-on-error > "{{ mirror_working_dir }}/logs/mirror-{{ catalog_index }}-$name"
  with_fileglob:
    - "{{ mirror_working_dir }}/manifests/to-filesystem/mapping.txt_*"
