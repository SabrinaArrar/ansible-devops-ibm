---
# 1. Check for undefined properties that do not have a default
# -----------------------------------------------------------------------------
- name: "Assert that mas_instance_id & mas_channel are defined"
  assert:
    that:
      - mas_instance_id is defined and mas_instance_id != ""
      - mas_channel is defined and mas_channel != ""
    fail_msg: "mas_instance_id & mas_channel are required"


# 2. Provide debug information
# -----------------------------------------------------------------------------
- name: "Debug information"
  debug:
    msg:
      - "Target Channel ......................... {{ mas_channel }}"
      - "MAS Instance ID ........................ {{ mas_instance_id }}"
      - "MAS namespace .......................... {{ mas_namespace }}"
      - "Dry Run? ............................... {{ mas_upgrade_dryrun }}"


# 3. Check the existing installation
# -----------------------------------------------------------------------------
- name: "Check existing MAS installation"
  include_tasks: tasks/check_core_compatibility.yml


# 4. Check installed applications are compatible
# -----------------------------------------------------------------------------
# 4.1. Assist
- name: "Check application compatibility for Assist"
  when:
    - suite_sub_info.resources[0].spec.channel != mas_channel
  include_tasks: tasks/check_app_compatibility.yml
  vars:
    check_app:
      id: assist
      kind: AssistApp
      api_version: apps.mas.ibm.com/v1

# 4.2. HPUtils
- name: "Check application compatibility for HPUtils"
  when:
    - suite_sub_info.resources[0].spec.channel != mas_channel
  include_tasks: tasks/check_app_compatibility.yml
  vars:
    check_app:
      id: hputilities
      kind: HPUtilitiesApp
      api_version: apps.mas.ibm.com/v1

# 4.3. IoT
- name: "Check application compatibility for IoT"
  when:
    - suite_sub_info.resources[0].spec.channel != mas_channel
  include_tasks: tasks/check_app_compatibility.yml
  vars:
    check_app:
      id: iot
      kind: IoT
      api_version: iot.ibm.com/v1

# 4.4 Manage
- name: "Check application compatibility for Manage"
  when:
    - suite_sub_info.resources[0].spec.channel != mas_channel
  include_tasks: tasks/check_app_compatibility.yml
  vars:
    check_app:
      id: manage
      kind: ManageApp
      api_version: apps.mas.ibm.com/v1

# 4.5. Monitor
- name: "Check application compatibility for Monitor"
  when:
    - suite_sub_info.resources[0].spec.channel != mas_channel
  include_tasks: tasks/check_app_compatibility.yml
  vars:
    check_app:
      id: monitor
      kind: MonitorApp
      api_version: apps.mas.ibm.com/v1

# 4.6. Predict
- name: "Check application compatibility for Predict"
  when:
    - suite_sub_info.resources[0].spec.channel != mas_channel
  include_tasks: tasks/check_app_compatibility.yml
  vars:
    check_app:
      id: predict
      kind: PredictApp
      api_version: apps.mas.ibm.com/v1

# 4.7. Safety
- name: "Check application compatibility for Safety"
  when:
    - suite_sub_info.resources[0].spec.channel != mas_channel
  include_tasks: tasks/check_app_compatibility.yml
  vars:
    check_app:
      id: safety
      kind: Safety
      api_version: apps.mas.ibm.com/v1

# 4.8. Visual Inspection
- name: "Check application compatibility for Visual Inspection"
  when:
    - suite_sub_info.resources[0].spec.channel != mas_channel
  include_tasks: tasks/check_app_compatibility.yml
  vars:
    check_app:
      id: visualinspection
      kind: VisualInspection
      api_version: apps.mas.ibm.com/v1

# 4.9. Optimizer
- name: "Check application compatibility for Optimizer"
  when:
    - suite_sub_info.resources[0].spec.channel != mas_channel
  include_tasks: tasks/check_app_compatibility.yml
  vars:
    check_app:
      id: optimizer
      kind: OptimizerApp
      api_version: apps.mas.ibm.com/v1


# 5. Upgrade
# -----------------------------------------------------------------------------
- name: "Execute Channel Upgrade"
  when:
    - suite_sub_info.resources[0].spec.channel != mas_channel
    - not mas_upgrade_dryrun
  include_tasks: tasks/upgrade.yml

- name: "Debug when we are already on the desired channel"
  when: suite_sub_info.resources[0].spec.channel == mas_channel
  debug:
    msg: "No action required, subscription is already on the {{ mas_channel }} channel"
