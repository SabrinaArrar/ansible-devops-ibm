---
# 1. Provide debug information to the user
# -----------------------------------------------------------------------------
- name: "Debug information"
  debug:
    msg:
      - "Namespace .................... {{ cpd_meta_namespace }}"
      - "Storage class ................ {{ cpd_storage_class }}"
      - "CP4D services ................ {{ cpd_services }}"

# 1. Load var files
# -----------------------------------------------------------------------------
- name: Load variables
  include_vars: "vars/defaults.yml"

# - name: "wait : Check service subscription operators"
#   vars:
#     service_name: "{{ item }}"
#   debug:
#     msg: "{{ hostvars[inventory_hostname][item].alias }}Status"
#   with_items: "{{ cpd_services }}"

# 2. Install CP4D Services Subscriptions
# -----------------------------------------------------------------------------
- name: "Install CP4D Services Subscription"
  vars:
    service_name: "{{ item }}"
  community.kubernetes.k8s:
    apply: yes
    definition: "{{ lookup('template', 'templates/{{ item }}/subscription.yml') }}"
  with_items: "{{ cpd_services }}"

# 3. Wait for CP4D Services Subscriptions to be ready
# -----------------------------------------------------------------------------
- include_tasks: wait_for_subscriptions.yml

# 4. Install CP4D Services CRs
# -----------------------------------------------------------------------------
- name: "Install Services CR"
  vars:
    service_name: "{{ item }}"
  community.kubernetes.k8s:
    apply: yes
    definition: "{{ lookup('template', 'templates/{{ item }}/service.yml') }}"
  with_items: "{{ cpd_services }}"

# 5. Wait for CP4D Services to be ready
# -----------------------------------------------------------------------------
- include_tasks: wait_for_services.yml
