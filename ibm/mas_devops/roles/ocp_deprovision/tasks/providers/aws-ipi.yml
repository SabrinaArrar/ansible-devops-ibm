---
# 1. Failure conditions
# -----------------------------------------------------------------------------
# Note that environment variables AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY
# are required by the AWS IPI openshift installer, they must be provided as
# environment variables, rather than just as parameters to Ansible
#
# Infuture, we could check if they are defined, and if not set them when
# we run the command, but as we mostly drive the role via environment variables
# that seems rather redundant at present.
- name: "aws-ipi : Fail if below variables not provided"
  assert:
    that:
      - lookup('env', 'AWS_ACCESS_KEY_ID') != ""
      - lookup('env', 'AWS_SECRET_ACCESS_KEY') != ""
    fail_msg: "One or more required environment variables are not defined"

- name: "aws-ipi : Default OCP version to latest"
  when: ocp_version is not defined or ocp_version == ""
  set_fact:
    ocp_version: latest


# 2. Debug Info
# -----------------------------------------------------------------------------
- name: "aws-ipi: Debug information"
  debug:
    msg:
      - "Cluster name ........................... {{ cluster_name }}"
      - "OCP Version ............................ {{ ocp_version }}"
      - "OCP Install Dir ........................ {{ ocp_install_dir }}"
      - "OCP Installer Dir ...................... {{ ocp_installer_dir }}"
      - "AWS Access Key ......................... {{ aws_access_key_id }}"
      - "AWS Secret Access Key .................. {{ aws_secret_access_key }}"


# 3. Install the installer
# -----------------------------------------------------------------------------
- name: "aws-ipi : Check ocp_installer_dir"
  stat:
    path: "{{ ocp_installer_dir }}"
  register: ocp_installer_dir_lookup

- name: "aws-ipi : Create ocp_installer_dir if it does not exist"
  when: not ocp_installer_dir_lookup.stat.exists
  file:
    path: "{{ ocp_installer_dir }}"
    state: directory
    mode: '755'

- name: "aws-ipi : Check ocp_installer_exe exists"
  stat:
    path: "{{ ocp_installer_exe }}"
  register: ocp_installer_exe_lookup

- name: "aws-ipi : Download the correct OCP Installer"
  when: not ocp_installer_dir_lookup.stat.exists
  unarchive:
    src: "https://mirror.openshift.com/pub/openshift-v4/x86_64/clients/ocp/{{ ocp_version }}/openshift-install-linux.tar.gz"
    dest: "{{ ocp_installer_dir }}"
    remote_src: yes


# 4. Build the install-config.yaml
# -----------------------------------------------------------------------------
- name: "aws-ipi : Check ocp_install_config_dir"
  stat:
    path: "{{ ocp_install_config_dir }}"
  register: sno_config_directory


# 5. Destroy SNO Cluster
# -----------------------------------------------------------------------------
- name: "aws-ipi : Destroy SNO cluster"
  when: sno_config_directory.stat.exists
  shell: openshift-install destroy cluster --dir={{ ocp_install_config_dir }}
  register: aws_sno_cluster_completion
  until:
    - aws_sno_cluster_completion.rc == 0
  retries: 60
  delay: 60

- name: "aws-ipi : Debug final cluster state"
  debug:
    msg: "{{ aws_sno_cluster_completion.stdout}}"
