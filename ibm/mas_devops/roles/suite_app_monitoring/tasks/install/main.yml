---

# 1. Install OpenTelemetry Operator
# -------------------------------------------------------------------------------------
- name: "install: opentelemetry: Apply OpenTelemetry operatorgroup"
  kubernetes.core.k8s:
    apply: yes
    definition: "{{ lookup('template', 'templates/operator-group.yaml') }}"

- name: "install: opentelemetry: Create OpenTelemetry Operator Subscription"
  kubernetes.core.k8s:
    definition: "{{ lookup('template', 'templates/subscription.yaml') }}"
    wait: yes
    wait_timeout: 120

- name: "install: opentelemetry: Lookup and Approve OpenTelemetry Operator Subscription"
  block:
    - name: "install: opentelemetry: Lookup OpenTelemetry Operator install plan"
      kubernetes.core.k8s_info:
        api_version: operators.coreos.com/v1alpha1
        kind: InstallPlan
        namespace: "openshift-operators"
        label_selectors:
          - operators.coreos.com/opentelemetry-operator.openshift-operators
      register: otel_installplan_info
      retries: 20
      delay: 60 # Retry for approx 20 minutes (60s * 20 attempts) before giving up
      until: otel_installplan_info.resources | length > 0

    - name: "install: opentelemetry: Approve OpenTelemetry Operator install plan"
      when:
        - otel_installplan_info.resources[0].status.phase != "Complete"
      kubernetes.core.k8s:
        definition:
          apiVersion: operators.coreos.com/v1alpha1
          kind: InstallPlan
          metadata:
            name: "{{ otel_installplan_info.resources[0].metadata.name }}"
            namespace: "openshift-operators"
          spec:
            approved: true

    - name: "install: opentelemetry: Wait for OpenTelemetry Operator install to complete"
      when:
        - otel_installplan_info.resources[0].status.phase != "Complete"
      kubernetes.core.k8s_info:
        api_version: operators.coreos.com/v1alpha1
        kind: InstallPlan
        name: "{{ otel_installplan_info.resources[0].metadata.name }}"
        namespace: "openshift-operators"
      register: otel_installplan_info
      retries: 20
      delay: 30 # Retry for approx 10 minutes (30s * 20 attempts) before giving up
      until:
        - otel_installplan_info.resources[0].status.phase is defined
        - otel_installplan_info.resources[0].status.phase == "Complete"

# 2. Wait until the OpenTelemetryCollector CRD is available
# -----------------------------------------------------------------------------
- name: "install: opentelemetry: Wait until the OpenTelemetryCollector CRD is available"
  kubernetes.core.k8s_info:
    api_version: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: "opentelemetrycollectors.opentelemetry.io"
    wait: yes
    wait_sleep: 10
    wait_timeout: 300 # 5 mins until we give up waiting for the CRD to get into the expected state
    wait_condition:
      type: NamesAccepted
      status: "True"
  register: otelcollector_crd_info
  retries: 60 # ~approx 10 minutes before we give up waiting for the CRD to be created
  delay: 10 # seconds
  until:
    - otelcollector_crd_info.resources is defined
    - otelcollector_crd_info.resources | length > 0
