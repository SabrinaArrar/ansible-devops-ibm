---
# 1. Provide debug information to the user
# -----------------------------------------------------------------------------
- name: "Debug information"
  debug:
    msg:
      - "AWS Region.............................. {{ aws_region }}"
      - "AWS User Name readwrite ................ {{ aws_bucket_read_write_username }}"
      - "AWS Bucket ARN ......................... {{ aws_bucket_arn }}"

- set_fact:
    s3readwrite_policy: "s3readwrite-policy-{{ aws_bucket_read_write_username }}" 

- name: "Create a new read write policy for bucket {{ aws_bucket_name }}"
  shell: |
    aws iam create-policy \
    --policy-name {{ s3readwrite_policy }} \
    --policy-document \
    '{
        "Version": "2012-10-17",
        "Statement": [
            {
                "Sid":"VisualEditor0",
                "Effect": "Allow",
                "Action": [
                  "s3:GetObject",
                  "s3:ListBucket",
                  "s3:DeleteObject",
                  "s3:PutObject"
                ],
                "Resource": [
                  "{{ aws_bucket_arn }}/*",
                  "{{ aws_bucket_arn }}"
                ]
            }
        ]
    }'
  register: iam_readwrite_policy_create_output
  failed_when: iam_readwrite_policy_create_output.rc > 0 and ('EntityAlreadyExists' not in iam_readwrite_policy_create_output.stderr)

- name: "Lookup s3readwrite policy"
  shell: aws iam list-policies --query 'Policies[?PolicyName==`{{ s3readwrite_policy }}`].Arn' --output text
  register: iam_readwrite_policy_lookup_output

- set_fact:
    s3readwrite_policy_arn: "{{ iam_readwrite_policy_lookup_output.stdout }}"
