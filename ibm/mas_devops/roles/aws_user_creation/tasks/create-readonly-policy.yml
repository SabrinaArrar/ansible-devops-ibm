---
# 1. Provide debug information to the user
# -----------------------------------------------------------------------------
- name: "Debug information"
  debug:
    msg:
      - "AWS Region.............................. {{ aws_region }}"
      - "AWS User Name readonly ................. {{ aws_bucket_read_only_username }}"
      - "AWS Bucket ARN ......................... {{ aws_bucket_arn }}"

- set_fact:
    s3readonly_policy: "s3readonly-policy-{{ aws_bucket_read_only_username }}"

- name: "Create a new read only policy for bucket {{ aws_bucket_name }}"
  shell: |
    aws iam create-policy \
    --policy-name {{ s3readonly_policy }} \
    --policy-document \
    '{
        "Version": "2012-10-17",
        "Statement": [
            {
                "Sid":"VisualEditor0",
                "Effect": "Allow",
                "Action": [
                  "s3:GetObject",
                  "s3:ListBucket"  
                ],
                "Resource": [
                  "{{ aws_bucket_arn }}/*",
                  "{{ aws_bucket_arn }}"
                ]
            }
        ]
    }'
  register: iam_readonly_policy_create_output
  failed_when: iam_readonly_policy_create_output.rc > 0 and ('EntityAlreadyExists' not in iam_readonly_policy_create_output.stderr)

- name: "Lookup s3readonly policy"
  shell: aws iam list-policies --query 'Policies[?PolicyName==`{{ s3readonly_policy }}`].Arn' --output text
  register: iam_readonly_policy_lookup_output

- set_fact:
    s3readonly_policy_arn: "{{ iam_readonly_policy_lookup_output.stdout }}"
