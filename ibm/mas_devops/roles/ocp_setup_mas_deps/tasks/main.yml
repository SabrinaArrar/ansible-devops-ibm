---

# 1. Install IBM catalogs
# -----------------------------------------------------------------------------
- name: "Create IBM catalogs"
  community.kubernetes.k8s:
    definition: "{{ lookup('template', 'templates/ibm-catalogs.yml') }}"


# 2. Install development (pre-release) catalogs
# -----------------------------------------------------------------------------
- name: "Install development (pre-release) catalogs"
  when:
    - artifactory_username is defined
    - artifactory_username != ""
    - artifactory_apikey is defined
    - artifactory_apikey != ""
    - not airgap_install
  include_tasks: "tasks/development-catalogs.yml"


# 3. Install cert-manager
# -----------------------------------------------------------------------------
- name: Check if Cert Manager is already installed
  community.kubernetes.k8s_info:
    api_version: v1
    name: cert-manager
    namespace: "cert-manager"
    kind: Deployment
  register: _cert_manager_deployed

# Install foundation services cert-manager if MAS 8.7+, otherwise, install jetstack/standalone version
- name: Define which Cert Manager to install
  set_fact:
    cm_version: "{{ 'foundation-services' if (mas_channel in mas87_channels) else 'standalone' }}"
  when:
    - (_cert_manager_deployed.resources | length) == 0
    - not airgap_install

- include_tasks: "tasks/certmanager/{{ cm_version }}.yml"
  when:
    - cm_version is defined and cm_version !=''
    - (_cert_manager_deployed.resources | length) == 0
    - not airgap_install


# 4. Install Service Binding Operator
# -----------------------------------------------------------------------------
# Install stable channel with automatic updates if MAS 8.7+, otherwise, install preview channel locked to v0.8
- name: Get OCP Version
  kubernetes.core.k8s_info:
    api_version: v1
    kind: ConfigMap
    name: openshift-install
    namespace: openshift-config
  register: _openshift_config
- set_fact:
    ocp_version: "{{ _openshift_config.resources[0].data.version | regex_search('[^.]*.[^.]*') }}"

- name: Define which SBO to install
  when:
    - not airgap_install
  set_fact:
    sbo_channel: "{{ 'stable' if (mas_channel in mas87_channels and ocp_version != '4.6') else 'preview' }}"

- include_tasks: "tasks/sbo/{{ sbo_channel }}.yml"
  when:
    - not airgap_install


# 5. Update openshift monitoring to define a specific storage class for Prometheus logs
# -------------------------------------------------------------------------------------
# All other settings have defaults, but the user must set prometheus_storage_class and
# prometheus_alertmgr_storage_class for us to be able to apply this configuration
- name: Set storage class and retention period for Prometheus logs
  when:
    - prometheus_storage_class is defined
    - prometheus_storage_class != ""
    - prometheus_alertmgr_storage_class is defined
    - prometheus_alertmgr_storage_class != ""
  community.kubernetes.k8s:
    definition: "{{ lookup('template', 'templates/cluster-monitoring/configmap.yml') }}"
    wait: yes
    wait_timeout: 120


# 6. Increase cluster image registry from defautl 100Gi to 400Gi (cp4d images consume lot of space)
# -------------------------------------------------------------------------------------
- name: "Increase cluster image registry"
  when: cluster_type == "roks"
  command: bash "{{ role_path }}"/files/configImgRegStorage.sh
  register: result

- name: Debug Image Registry Volume order request
  debug: msg="{{ result }}"
