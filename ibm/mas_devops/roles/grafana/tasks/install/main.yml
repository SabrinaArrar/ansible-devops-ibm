---

# 1. Load default storage classes (if not provided by the user)
# -----------------------------------------------------------------------------
- name: "install : Determine storage classes"
  include_tasks: tasks/install/determine-storage-classes.yml


# 2. Ensure User Workload Monitoring is Enabled
# -----------------------------------------------------------------------------
- block:
  - name: "install : Check User Workload Monitoring Workspace"
    kubernetes.core.k8s_info:
      api: v1
      kind: namespace
      name: openshift-user-workload-monitoring
      namespace: openshift-user-workload-monitoring
    register: uwm_workspace

  - name: "install : Configure User Workload Monitoring"
    when: uwm_workspace.resources | length == 0
    kubernetes.core.k8s:
      template: templates/cluster-monitoring-config.yml.j2

  - name: "install : Confirm User Workload Monitoring Workspace"
    kubernetes.core.k8s_info:
      api: v1
      kind: namespace
      name: openshift-user-workload-monitoring
      namespace: openshift-user-workload-monitoring
    register: uwm_workspace
    until:
      - uwm_workspace.resources | length > 0
    retries: 10
    delay: 60

  rescue:
    - fail:
      msg: >
        openshift-user-workload-monitoring namespace not found
        clustermonitoring may not be configured correctly


# 3. Install and configure Grafana
# -----------------------------------------------------------------------------
- name: "install : Install Grafana"
  include_tasks: "tasks/install/grafana-v{{grafana_major_version}}.yml"
