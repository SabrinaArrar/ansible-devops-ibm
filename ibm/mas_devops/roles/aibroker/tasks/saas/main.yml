---
- name: Apply Kmodel api
  shell: |
    curl -k -X POST "https://controller-mas-{{ mas_instance_id }}-aibroker.{{ mas_aibroker_domain }}/api/v1/tenant?id=provision-tenant" \
    --header 'accept: */*' \
    --header 'Content-Type: application/json' \
    --data '{"name": "string","public": true,"max_models": 10}'

- name: "Check if API key secret exists in namespace: provision-tenant"
  k8s_info:
    api_version: v1
    kind: Secret
    name: "provision-tenant----apikey-secret"
    namespace: "{{ aibroker_namespace }}"
  register: apikey_secret_info

- name: Create API Key
  script: "{{ role_path }}/files/create_apikey.sh provision-tenant {{ aibroker_namespace }}"
  when:
    - apikey_secret_info.resources | length == 0

- name: "Lookup tenant provision-tenant api key"
  shell: oc get secret provision-tenant----apikey-secret -n {{ aibroker_namespace }} -o json | jq -r '.data.AIBROKER_APIKEY' | base64 -d
  register: provision_tenant_api_key_output

- name: "Set aibroker api key variable"
  set_fact:
    provision_tenant_api_key: "{{ provision_tenant_api_key_output.stdout }}"

- name: "Create tenant {{ tenantNamespace }} and add to db2 for saas"
  shell: |
    curl -k -X POST "https://aibroker.{{ mas_instance_id }}.{{ mas_aibroker_domain }}/ibm/aibroker/service/rest/api/v1/tenant" \
    --header 'apikey: {{ provision_tenant_api_key }}' \
    --header 'accept: */*' \
    --header 'Content-Type: application/json' \
    --header 'tenantid: provision-tenant' \
    --data ' {"tenant_name": "{{ tenantNamespace }}", "sls_url": "{{ mas_aibroker_sls_url }}", "dro_url": "{{ mas_aibroker_dro_url }}"}'
  register: add_tenant_to_db2

- name: Debug tenant #TODO: remove on finall commit
  debug:
    msg: "{{ add_tenant_to_db2 }}"

- name: "Create tenantEntitlements {{ tenantNamespace }} and add to db2 for saas"
  shell: |
    curl -k -X POST "https://aibroker.{{ mas_instance_id }}.{{ mas_aibroker_domain }}/ibm/aibroker/service/rest/api/v1/tenantEntitlements" \
    --header 'apikey: {{ provision_tenant_api_key }}' \
    --header 'accept: */*' \
    --header 'Content-Type: application/json' \
    --header 'tenantid: provision-tenant' \
    --data '{"tenant_name": "{{ tenantNamespace }}", "entitlement_type": "standard", "model_type": "similarity", "entitlement_start_date": "2024-01-01", "entitlement_end_date": "2025-01-01"}'
  register: add_tenant_entitlements_to_db2

- name: Debug tenant entitlement #TODO: remove on finall commit
  debug:
    msg: "{{ add_tenant_entitlements_to_db2 }}"
