- name: Lookup for instance credentials Secret
  community.kubernetes.k8s_info:
    api_version: v1
    kind: Secret
    name: "masms-{{ mas_instance_id }}-sendgrid-credentials"
    namespace: "mas-{{ mas_instance_id }}-core"
  register: _instance_smtp_key

- name: Create send grid user
  block:
    - name: Set Facts
      set_fact:
        _masms_smtp_user_password: "{{ lookup('password', '/dev/null chars=ascii_letters,digits,punctuation length=20') }}"

    - name: Check if subuser already exist
      uri:
        url: "https://{{ sendgrid_api_url }}/v3/subusers/{{ masms_smtp_user_name }}"
        validate_certs: no
        method: GET
        headers:
          Authorization: "Bearer {{ sendgrid_apikey }}"
          cache-control: "no-cache"
        status_code: [201, 404, 200]
        timeout: 30
      register: _user_exist_result

    - name: Create subuser if user does not exist
      when:
        - _user_exist_result.status == 404
      uri:
        url: "https://{{ sendgrid_api_url }}/v3/subusers"
        validate_certs: no
        method: POST
        headers:
          Authorization: "Bearer {{ sendgrid_apikey }}"
          cache-control: "no-cache"
        body_format: "json"
        body:
          username: "{{ masms_smtp_user_name }}"
          email: "{{ masms_smtp_email }}"
          password: "{{ _masms_smtp_user_password }}"
          ips:
            - "149.72.75.134"
        status_code: 201
        timeout: 30
      register: _create_user_result

    - name: Generate API Key for Subuser
      when:
        - _subuser_apikey.status == 404
      uri:
        url: "https://{{ sendgrid_api_url }}/v3/api_keys"
        validate_certs: no
        method: POST
        headers:
          Authorization: "Bearer {{ sendgrid_apikey }}"
          On-behalf-of: "{{masms_smtp_user_name}}"
          cache-control: "no-cache"
        body_format: "json"
        body:
          name: "{{masms_smtp_user_name}}_apikey"
          scopes:
            - "mail.send"
        status_code: 201
        timeout: 30
      register: _subuser_apikey

    - name: Perform Single Sender Authentication
      when:
        - _user_exist_result.status == 404
      changed_when:
        - (_result.json.errors is not defined or _result.json.errors[0].message == 'already exists')
      register: _result
      uri:
        url: "https://{{ sendgrid_api_url }}/v3/verified_senders"
        validate_certs: no
        method: POST
        headers:
          Authorization: "Bearer {{ sendgrid_apikey }}"
          On-behalf-of: "{{masms_smtp_user_name}}"
          cache-control: "no-cache"
        body_format: "json"
        body:
          nickname: "{{ masms_smtp_email }}"
          from_email: "{{ masms_smtp_email }}"
          from_name: "{{ masms_smtp_email }}"
          reply_to: "{{ masms_smtp_email }}"
          reply_to_name: ""
          address: "250 York St #301"
          address2: ""
          state: "ON"
          city: "London"
          country: "Canada"
          zip: "N6A 6K2"
        status_code: 201, 400
        timeout: 30
  when:
    - not _instance_smtp_key.resources | length > 0
- name: Set apikey
  when: (_subuser_apikey.changed or _instance_smtp_key.resources | length > 0)
  set_fact:
    sendgrid_user_apikey: "{{(_subuser_apikey is defined and _subuser_apikey.json is defined) | ternary(_subuser_apikey.json.api_key, _instance_smtp_key.resources[0].data.api_key | b64decode)}}"
- name: Copy SMTPCfg to filesystem
  ansible.builtin.template:
    src: "sendgrid/smtpcfg.yml.j2"
    dest: "{{ mas_config_dir }}/smtp-{{ mas_instance_id | lower }}.yml"
  when:
    - _existent_smtp.resources | length == 0
    - sendgrid_user_apikey is defined
