---
# 1. Check the cluster is ready
# -----------------------------------------------------------------------------
- name: Check if cluster is ready
  kubernetes.core.k8s_info:
    api_version: config.openshift.io/v1
    name: version
    kind: ClusterVersion
  register: ocp_info
  retries: 60 # ~approx 1 hour before we give up
  delay: 60 # seconds
  until:
    - ocp_info.resources is defined
    - ocp_info.resources | json_query('[*].status.conditions[?type==`Available`][].status') | select ('match','True') | list | length == 1


# 2. Wait for all catalogsources to be healthy
# -----------------------------------------------------------------------------
- name: Check CatalogSource Status
  ibm.mas_devops.verify_catalogsources:
    retries: 10
    delay: 30


# 3. Wait for all subscriptions in all namespaces to get into AtLatestKnown state
# -----------------------------------------------------------------------------
- name: Check Subscription Status
  ibm.mas_devops.verify_subscriptions:
    retries: 10
    delay: 30


# 4. Wait for all deployments & statefulsets in all namespaces to be healthy
# -----------------------------------------------------------------------------
- name: Check Deployment & StatefulSet Status
  ibm.mas_devops.verify_workloads:
    retries: 10
    delay: 5


# 5. Check for router and ingress secrets
# -----------------------------------------------------------------------------
- name: "Lookup the default cluster ingress secret"
  include_tasks: "{{ role_path }}/../../common_tasks/get_ingress_cert.yml"
