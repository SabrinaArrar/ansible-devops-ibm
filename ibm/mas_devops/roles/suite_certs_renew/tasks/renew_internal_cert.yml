---
- name: "Lookup original {{ mas_instance_id }}-{{ cert_name }}-cert-internal data"
  kubernetes.core.k8s_info:
    api_version: v1
    name: "{{ mas_instance_id }}-{{ cert_name }}-cert-internal"
    namespace: "{{ mas_namespace }}"
    kind: Secret
  register: internalcert_original_data
  failed_when: internalcert_original_data.resources[0] | length == 0

- name: "Run cmctl renew command"
  shell: cmctl renew {{mas_instance_id}}-{{ cert_name }}-cert-internal

- name: "Wait for {{ mas_instance_id }}-{{ cert_name }}-cert-internal to be renewed (30s delay)"
  kubernetes.core.k8s_info:
    api_version: v1
    name: "{{ mas_instance_id }}-{{ cert_name }}-cert-internal"
    namespace: "{{ mas_namespace }}"
    kind: Secret
  register: internalcert_new_data
  until:
    - internalcert_new_data.resources[0] is defined
  retries: 5 # approx 5 minutes before we give up
  delay: 30 # 30 Seconds

- name: "Assert new 'tls.crt' in {{ mas_instance_id }}-{{ cert_name }}-cert-internal secret is different from the one prior to renewal"
  assert:
    that:
    - internalcert_original_data.resources[0].data['tls.crt'] != new_secret_result.resources[0].data['tls.crt']
    fail_msg: "Assertion Failed! The new 'tls.crt' in {{ mas_instance_id }}-{{ cert_name }}-cert-internal  remains the same as it did before renewal."
    success_msg: "Assertion Passed! Original 'tls.crt' in {{ mas_instance_id }}-{{ cert_name }}-cert-internal  has been successfully renewed."

- name: "Assert that 'ca.crt' in {{ mas_instance_id }}-{{ cert_name }}-cert-internal  has not been changed during the renewal process"
  assert:
    that:
    - internalcert_original_data.resources[0].data['ca.crt'] != new_secret_result.resources[0].data['ca.crt']
    fail_msg: "Assertion Failed! Original {{ mas_instance_id }}-{{ cert_name }}-cert-internal  CA has been erroneuously changed."
    success_msg: "Assertion Passed! Original 'ca.crt' in {{ mas_instance_id }}-{{ cert_name }}-cert-internal remains unchanged as intended."
