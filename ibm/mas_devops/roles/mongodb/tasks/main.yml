---

# 1. Check for undefined properties that do not have a default
# -----------------------------------------------------------------------------
- name: "Fail if mongodb_provider is not provided"
  assert:
    that: mongodb_provider is defined and mongodb_provider != ""
    fail_msg: "mongodb_provider property is required"

- name: "Fail if catalog_tag is not provided"
  assert:
    that: catalog_tag is defined and catalog_tag != ""

# 2. Debug Properties
# -----------------------------------------------------------------------------
- name: "Initial Debug properties"
  debug:
    msg:
      - "MongoDb provider ....................... {{ mongodb_provider }}"

# 3. Load default settings
# -----------------------------------------------------------------------------
- name: Load CASE bundle versions
  include_vars:
    file: "{{ role_path }}/../../common_vars/casebundles/{{ catalog_tag }}.yml"

- name: Load mongo defaults
  include_vars:
    file: "{{ role_path }}/../mirror_extras_prepare/vars/mongoce_{{ mongo_extras_version }}.yml"

- name: set facts
  when:
    - mongodb_provider == "community"
  set_fact:
    target_mongodb_version: "{{ mongo_extras_version }}"
    target_mongo_operator_image_registry: "{{ extra_images | selectattr('name', 'equalto', 'ibmmas/mongodb-kubernetes-operator') | map(attribute='registry') | first }}"
    target_mongo_operator_image_digest: "{{ extra_images | selectattr('name', 'equalto', 'ibmmas/mongodb-kubernetes-operator') | map(attribute='digest') | first }}"
    target_mongo_operator_image_tag: "{{ extra_images | selectattr('name', 'equalto', 'ibmmas/mongodb-kubernetes-operator') | map(attribute='tag') | first }}"
    target_mongodb_image_registry: "{{ extra_images | selectattr('name', 'equalto', 'ibmmas/mongo') | map(attribute='registry') | first }}"
    target_mongodb_image_digest: "{{ extra_images | selectattr('name', 'equalto', 'ibmmas/mongo') | map(attribute='digest') | first }}"
    target_mongodb_image_tag: "{{ extra_images | selectattr('name', 'equalto', 'ibmmas/mongo') | map(attribute='tag' | first }}"

- name: set more facts
  when:
    - mongodb_provider == "community"
  set_fact:
    target_mongo_operator_image: "{{ target_mongo_operator_image_registry }}/ibmmas/mongodb-kubernetes-operator@{{ target_mongo_operator_image_digest }}"
    target_mongodb_image: "{{ target_mongodb_image_registry }}/ibmmas/mongo@{{ target_mongodb_image_digest }}"
    mongodb_ce_version: "{{ target_mongo_operator_image_tag }}"

- name: set even more facts
  when:
    - mongodb_provider == "community"
  set_fact:
    target_mongo_operator_image_version_map[mongodb_ce_version]['image']: "{{ target_mongo_operator_image }}"

# 4. Debug Properties
# -----------------------------------------------------------------------------
- name: "Debug properties"
  when:
    - mongodb_provider == "community"
  debug:
    msg:
      - "MongoDb operator version ............... {{ mongodb_ce_version }}"
      - "MongoDb operator image ................. {{ target_mongo_operator_image }}"
      - "MongoDb version ........................ {{ target_mongodb_version }}"
      - "MongoDb image .......................... {{ target_mongodb_image }}"

# 5. Load default storage classes (if not provided by the user)
# -----------------------------------------------------------------------------
- include_tasks: tasks/determine-storage-classes.yml
  when:
    - mongodb_provider == "community"
    - mongodb_action != "none"

# 6. Run the install / uninstall for specified provider
# -----------------------------------------------------------------------------
- include_tasks: "tasks/providers/{{ mongodb_provider }}/{{ mongodb_action }}.yml"
  when:
    - mongodb_action != "none"
