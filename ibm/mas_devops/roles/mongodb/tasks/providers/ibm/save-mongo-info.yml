# 1. Save Mongo host and port into K8s Configmap
# -----------------------------------------------------------------------------
- name: Set the var for mongo_host_port_string from TF output
  set_fact:
    mongo_host_port_string: "{{ mongo_instance_info.resource.connectionstrings[0].composed.split('@')[1].split('/')[0] }}"

- name: Set the var for mongo hosts and ports
  set_fact:
    mongo_host_0: "{{ mongo_instance_info.resource.connectionstrings[0].hosts[0].hostname }}"
    mongo_host_1: "{{ mongo_instance_info.resource.connectionstrings[0].hosts[1].hostname }}"
    mongo_host_2: "{{ mongo_instance_info.resource.connectionstrings[0].hosts[2].hostname }}"
    mongo_port: "{{ mongo_instance_info.resource.connectionstrings[0].hosts[0].port }}"

- name: Set the var for resource id from TF output
  set_fact:
    mongo_resource_id: "{{ mongo_instance_info.resource.id }}"

- name: Create a ConfigMap for mongo config
  ansible.builtin.template:
    src: ibm/mongo_config_configmap.yaml.j2
    dest: "{{ mas_config_dir }}/ibm-mongo-cm.yml"

- name: Create a Secret for mongo admin credentials
  ansible.builtin.template:
    src: ibm/mongo_admin_credentials_secret.yaml.j2
    dest: "{{ mas_config_dir }}/ibm-mongo-secret.yml"

- name: Create k8s ConfigMap for mongo Terraform outputs
  ansible.builtin.template:
    src: ibm/mongo_tf_outputs_configmap.yaml.j2
    dest: "{{ mas_config_dir }}/ibm-mongo-output-cm.yml"
