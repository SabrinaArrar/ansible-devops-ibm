---
# 1. set docdb admin user and password
# -----------------------------------------------------------------------------
- name: include vars for docdb specs according to the docdb_size specified
  include_vars:
    file: "{{mongodb_provider}}/{{ docdb_size }}.yml"
  when: docdb_size is defined and docdb_size != ""

- name: Generate docdb admin password
  no_log: true
  set_fact:
    docdb_master_password: "{{ lookup('password', '/dev/null length=20 chars=ascii_lowercase,ascii_uppercase,digits') }}"
  when: docdb_master_password is undefined or docdb_master_password == ""

# 2. Create three subnets in VPC
# -----------------------------------------------------------------------------

- name: Initialize facts for subnet ids
  set_fact:
    subnet_id_list: []

- name: Fetch availability Zones in VPC Reigon
  command: >
    aws ec2 describe-availability-zones
  register: az_info

- name: Set Fact for availability zones
  set_fact:
    az: "{{ az_info.stdout | from_json | json_query('AvailabilityZones') }}"

- name: Create Subnet in three availability Zones
  loop: ["{{docdb_cidr_az1}}","{{docdb_cidr_az2}}","{{docdb_cidr_az3}}"]
  loop_control:
    index_var: index
  command: >
    aws ec2 create-subnet \
      --vpc-id '{{ vpc_id }}' \
      --cidr-block '{{item}}' \
      --availability-zone '{{ az[index].ZoneName }}'
      --tag-specifications ResourceType=subnet,Tags=[{Key=Name,Value='{{ docdb_subnet_group_name }}'}]
  register: create_subnet_info

- name: Debug Subnet Creation Info
  debug:
    msg:
      - "{{ create_subnet_info.results[0].stdout | from_json }}"
      - "{{ create_subnet_info.results[1].stdout | from_json }}"
      - "{{ create_subnet_info.results[2].stdout | from_json }}"

- name: Update Fact for subnet Ids list
  loop: "{{ create_subnet_info.results }}"
  when: create_subnet_info is defined
  set_fact:
    subnet_id_list: "{{ subnet_id_list + [item.stdout | from_json | json_query('Subnet.SubnetId')] }}"

# 3. Create Subnet Group for DocDb Instances
# -----------------------------------------------------------------------------
- name: Create Subnet Group
  ignore_errors: yes
  command: >
    aws docdb create-db-subnet-group \
    --db-subnet-group-description 'Subnet Group for DocDB' \
    --db-subnet-group-name '{{ docdb_subnet_group_name }}' \
    --subnet-ids '{{subnet_id_list[0]}}' '{{subnet_id_list[1]}}' '{{subnet_id_list[2]}}'
  register: subnet_group_info

- debug:
    msg:
      - "subnet_group_info : {{ subnet_group_info.stdout | from_json }}"

# 4. Create Security Group and add ingress ,egress rules
# -----------------------------------------------------------------------------
- name: Create a Security Group
  command: >
    aws ec2 create-security-group \
    --group-name '{{ docdb_security_group_name }}' \
    --description "Enable inbound connection security group" \
    --vpc-id '{{ vpc_id }}'
  register: sg_info

- name: Get Security group Id
  set_fact: 
    sg_id: "{{sg_info.stdout | from_json | json_query('GroupId')}}"

- name: Add Ingress rule to SG"
  command: >
    aws ec2 authorize-security-group-ingress \
    --group-id '{{ sg_id }}' \
    --ip-permissions IpProtocol=tcp,FromPort=27017,ToPort=27017,IpRanges='[{CidrIp=10.1.0.0/23}]',Ipv6Ranges='[{CidrIpv6=::/0}]'
  register: ingress_rule_info

- name: Add Egress rule to SG"
  command: >
    aws ec2 authorize-security-group-egress \
    --group-id '{{ sg_id }}' \
    --ip-permissions IpProtocol=-1,FromPort=0,ToPort=0,IpRanges='[{CidrIp=10.1.0.0/23}]',Ipv6Ranges='[{CidrIpv6=::/0}]'
  register: egress_rule_info


# 5. Create DocumentDB Cluster and Instances
# -----------------------------------------------------------------------------
- name: Create DocDB Cluster
  command: >
    aws docdb create-db-cluster \
    --db-cluster-identifier '{{ docdb_cluster_name }}' \
    --engine docdb \
    --master-username '{{ docdb_master_username }}' \
    --master-user-password '{{ docdb_master_password }}' \
    --db-subnet-group-name '{{ docdb_subnet_group_name }}' \
    --vpc-security-group-ids  '{{sg_id}}' \ 
    --port 27017 \
    --engine-version '{{ docdb_engine_version }}'
  register: docdb_cluster_info

- name: Set Fact for Cluster Details
  set_fact:
    docdb_cluster_id: "{{ docdb_cluster_info.stdout | from_json | json_query('DBCluster.DbClusterResourceId') }}"
    docdb_cluster_arn: "{{ docdb_cluster_info.stdout | from_json | json_query('DBCluster.DBClusterArn') }}"
    docdb_cluster_endpoint: "{{ docdb_cluster_info.stdout | from_json | json_query('DBCluster.Endpoint') }}"
    docdb_cluster_port: "{{ docdb_cluster_info.stdout | from_json | json_query('DBCluster.Port') }}"
    docdb_cluster_reader_endpoint: "{{ docdb_cluster_info.stdout | from_json | json_query('DBCluster.ReaderEndpoint') }}"

- name: Create DocumentDB Cluster Instance
  command: >
    aws docdb create-db-instance \
    --db-cluster-identifier '{{ docdb_cluster_name }}' \
    --db-instance-class '{{ docdb_instance_class }}' \
    --db-instance-identifier '{{ docdb_cluster_name }}'-'{{ item }}' \
    --engine docdb
  register: docdb_cluster_intances_info
  with_sequence: start=1 end={{docdb_instance_number}}


- name: Fetch DocDb Instance 1 Info
  command: >
    aws docdb describe-db-instances \
      --db-instance-identifier '{{ docdb_cluster_name }}'-'1'
  register: docdb_cluster_intances_info_1
  until:
    - docdb_cluster_intances_info_1 is defined
    - docdb_cluster_intances_info_1.stdout is defined
    - docdb_cluster_intances_info_1.stdout | from_json | json_query('DBInstances[0].Endpoint.Address') != ''
  retries: 10
  delay: 60

- name: Fetch DocDb Instance 2 Info
  command: >
    aws docdb describe-db-instances \
      --db-instance-identifier '{{ docdb_cluster_name }}'-'2'
  register: docdb_cluster_intances_info_2
  until:
    - docdb_cluster_intances_info_2 is defined
    - docdb_cluster_intances_info_2.stdout is defined
    - docdb_cluster_intances_info_2.stdout | from_json | json_query('DBInstances[0].Endpoint.Address') != ''
  retries: 10
  delay: 60

- name: Fetch DocDb Instance 3 Info
  command: >
    aws docdb describe-db-instances \
      --db-instance-identifier '{{ docdb_cluster_name }}'-'3'
  register: docdb_cluster_intances_info_3
  until:
    - docdb_cluster_intances_info_3 is defined
    - docdb_cluster_intances_info_3.stdout is defined
    - docdb_cluster_intances_info_3.stdout | from_json | json_query('DBInstances[0].Endpoint.Address') != ''
  retries: 10
  delay: 60

- name: Set Fact for DB Instance Info
  set_fact:
    docdb_hosts: []

- name: Parse DocDB Host Address
  loop:
    - "{{docdb_cluster_intances_info_1}}"
    - "{{docdb_cluster_intances_info_2}}"
    - "{{docdb_cluster_intances_info_3}}"
  set_fact:
    docdb_hosts: "{{ docdb_hosts + [item.stdout | from_json | json_query('DBInstances[0].Endpoint.Address')] }}"

# 6. Store DocDB Cluster outputs
# -----------------------------------------------------------------------------
- name: Store DocDB outputs as ConfigMap
  when:
    - docdb_cluster_id is defined and docdb_cluster_id != ""
    - docdb_cluster_arn is defined and docdb_cluster_arn != ""
    - docdb_cluster_endpoint is defined and docdb_cluster_endpoint != ""
    - docdb_cluster_port is defined and docdb_cluster_port != ""
    - docdb_cluster_reader_endpoint is defined and docdb_cluster_reader_endpoint != ""
  ansible.builtin.template:
    src: aws/docdb_tf_outputs_configmap.yml.j2
    dest: "{{ mas_config_dir }}/docdb-cm.yml"

# 7. Download DocDB CA Cert from AWS and Create DocDB creds Secret and MongoCfg
# -----------------------------------------------------------------------------
- name: include vars for docdb specs according to the docdb_size specified
  include_vars:
    file: "{{mongodb_provider}}/{{ docdb_size }}.yml"
  when: docdb_size is defined and docdb_size != ""
- name: "Download Amazon DocumentDB Certificate Authority (CA) certificate"
  shell: |
    wget https://s3.amazonaws.com/rds-downloads/rds-combined-ca-bundle.pem -O /tmp/rds-combined-ca-bundle.pem

- name: Set DocumentDB certificates
  set_fact:
    docdb_master_certificates: "{{ lookup('file', '/tmp/rds-combined-ca-bundle.pem') }}"

- name: Create Secret for docdb admin credentials
  #no_log: true
  ansible.builtin.template:
    src: aws/docdb_master_user_credentials_secret.yaml.j2
    dest: "{{ mas_config_dir }}/docdb-master-secret.yml"

- name: Generate MongoCfg with DocDB details
  ansible.builtin.template:
    src: aws/suite_mongocfg.yml.j2
    dest: "{{ mas_config_dir }}/docdb-cfg.yml"