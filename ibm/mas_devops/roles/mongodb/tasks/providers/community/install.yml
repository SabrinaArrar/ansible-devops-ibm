---
# 1. Check for existing MongoDb install
# -----------------------------------------------------------------------------
- name: "community : install : Check mongo exists"
  include_tasks: tasks/providers/community/check-mongo-exists.yml


# 2. Load default storage classes (if not provided by the user and not an update)
# -----------------------------------------------------------------------------
- name: Use chosen (or default) storage class
  when: existing_mongo_storage_class is not defined
  include_tasks: tasks/providers/community/determine-storage-classes.yml

# Note: This will not override a storage class provided explicitly, thus allowing us
# to respect the chosen storage class (by failing the assertion that follows this task)
- name: Use existing storage class
  when:
    - existing_mongo_storage_class is defined
    - mongodb_storage_class == ""
  set_fact:
    - mongodb_storage_class: existing_mongo_storage_class

# If the user provided a storage class explicitly and it does not match what
# is currently in use, then we will fail because this role cannot change
# the storage class used by an existing MongoDb installation
- name: Validate existing and chosen storage classes match
  when: existing_mongo_storage_class is defined
  assert:
    that: mongodb_storage_class == existing_mongo_storage_class
    fail_msg:
      - "The selected storage class {{ mongodb_storage_class }} does not match the existing storage class in use {{ existing_mongo_storage_class }}"
      - "This role is unable to modify the storage used by an existing MongoDb installation"


# 3. Perform upgrade from 4.2 to 4.4 if necessary
# -----------------------------------------------------------------------------
- name: "community : install : Call install-mongo to upgrade from v4.2 to v4.4"
  include_tasks: tasks/providers/community/install-mongo.yml
  vars:
    mongo_extras_version: 4.4.21  # when identified that existing mongo is running on mongo v4.2, we first upgrade it to v4.4
  when:
    - existing_mongo_minor_version is defined
    - existing_mongo_minor_version == '4.2'


# 4. Check for existing MongoDb install (again)
# -----------------------------------------------------------------------------
- name: "community : install : Lookup existing mongo version"
  include_tasks: tasks/providers/community/check-mongo-exists.yml


# 5. Perform upgrade from 4.2 to 4.4 if necessary
# -----------------------------------------------------------------------------
- name: "community : install : Call install-mongo to install/upgrade to mongo v5 or v6"
  include_tasks: tasks/providers/community/install-mongo.yml  # at this point we expect existing mongo to be ready to be upgraded to v5 or v6
