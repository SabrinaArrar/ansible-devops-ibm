---
# 1. Provide debug information to the user
# -----------------------------------------------------------------------------
- name: "AWS Route53: Debug information"
  debug:
    msg:
      - "AWS Hosted Zone name ................................... {{ aws_route53_hosted_zone_name | default('Not Available, no will be created', true) }}"
      - "AWS Hosted Zone region ................................. {{ aws_route53_hosted_zone_region }}"
      - "AWS Route53 Cluster Issuer ............................. {{ aws_route53_cluster_issuer }}"

      


# # # 1. Create IAM Policy to allow cert-manager to add records to AWS Route53
# # # -----------------------------------------------------------------------------
# # - name: "aws-route53 : Create AWS IAM Policy to allow cert-manager to add records"
# #   import_role:
# #     name: ibm.mas_devops.aws_policy
# #   vars:
# #     aws_policy_name: "{{ mas_instance_id }}-{{ mas_workspace_id }}-route53-policy"
# #     aws_policy_statement:
# #       - Effect: Allow
# #         Action: route53:GetChange
# #         Resource: arn:aws:route53:::change/*
# #       - Effect: Allow
# #         Action:
# #         - route53:ChangeResourceRecordSets
# #         - route53:ListResourceRecordSets
# #         Resource: arn:aws:route53:::hostedzone/*
# #       - Effect: Allow
# #         Action: route53:ListHostedZonesByName
# #         Resource: "*"


# # aws route53 list-hosted-zones-by-name --dns-name andrercmaws.com

# 2. Create AWS Route 53 hosted zones
# -----------------------------------------------------------------------------
# - name: "aws-route53 : Lookup AWS Route53 Hosted zone instance"
#   shell: |
#     aws route53 list-hosted-zones-by-name | 
#     jq --arg name "{{ aws_route53_hosted_zone_name }}." \
#     -r '.HostedZones | .[] | select(.Name=="\($name)") | .Id'
#   register: aws_hosted_zone_lookup_output

# - set_fact:
#     aws_route53_hosted_zone_id: "{{ aws_hosted_zone_lookup_output.stdout | regex_replace('/hostedzone/', '''') }}"

- name: "aws-route53 : Lookup AWS Route53 Hosted zone instance"
  shell: |
    aws route53 list-hosted-zones-by-name --dns-name "{{ aws_route53_hosted_zone_name }}" --max-items 1 --output json
  register: aws_hosted_zone_lookup_output

- set_fact:
    aws_route53_hosted_zone_info: "{{ aws_hosted_zone_lookup_output.stdout }}"

- set_fact:
    aws_route53_hosted_zone_id: "{{ aws_route53_hosted_zone_info.HostedZones[0].Id | regex_replace('/hostedzone/', '''') }}"

# # - block:
# #     - name: "aws-route53 : Create AWS Route53 Hosted zone instance if none exists with name {{ aws_route53_hosted_zone_name }}"
# #       shell: |
# #         aws route53 create-hosted-zone \
# #         --name {{ aws_route53_hosted_zone_name }} \
# #         --caller-reference {{ aws_route53_caller_reference }} \
# #         --region {{ aws_route53_hosted_zone_region }} \
# #         --output json
# #       register: aws_hosted_zone_create_output
# #       failed_when: aws_hosted_zone_create_output.rc > 0 and ('HostedZoneAlreadyExists' not in aws_hosted_zone_create_output.stderr )

# #     - name: "aws-route53 : Lookup AWS Route53 Hosted Zone ID for {{ aws_route53_hosted_zone_name }}"
# #       when: aws_hosted_zone_lookup_output.stdout | length == 0
# #       shell: |
# #         aws route53 list-hosted-zones-by-name | 
# #         jq --arg name "{{ aws_route53_hosted_zone_name }}." \
# #         -r '.HostedZones | .[] | select(.Name=="\($name)") | .Id'
# #       register: aws_hosted_zone_lookup_output

# #     - set_fact:
# #         aws_route53_hosted_zone_id: "{{ aws_hosted_zone_lookup_output.stdout | regex_replace('/hostedzone/', '''') }}"

# #   when: aws_route53_hosted_zone_id | length == 0

- name: "Hosted Zone Id for {{ aws_route53_hosted_zone_name }}"
  debug:
    var: aws_route53_hosted_zone_id

# 3. Create AWS Route 53 cluster issuer
# -----------------------------------------------------------------------------
- name: "aws-route53 : Create AWS Route 53 cluster issuer: {{ aws_route53_cluster_issuer }}"
  kubernetes.core.k8s:
    namespace: "ibm-common-services"
    state: present
    template: templates/route53/clusterissuer.yml.j2

# # 4. Change cert-manager deployment 
# - '--dns01-recursive-nameservers-only'
# - '--dns01-recursive-nameservers=8.8.8.8:53'
# https://community.ibm.com/community/user/asset-facilities/blogs/brian-zhu/2022/10/08/using-lets-encrypt-ssl-certificates-with-maximo-ap?CommunityKey=3d7261ae-48f7-481d-b675-a40eb407e0fd


# list resources in the hosted zone: aws route53 list-resource-record-sets --hosted-zone-id "Z010310826HGIMGPRATUZ"
# 5. create cnames in the hosted zones
# awsroute53.andrercmaws.com > points to lb > a778573fe118e4659a2926df9b85875a-1425861465.us-east-2.elb.amazonaws.com.
# *.awsroute53.andrercmaws.com > points to lb > a778573fe118e4659a2926df9b85875a-1425861465.us-east-2.elb.amazonaws.com.

# 5. create A entries in the hosted zones
# api.rosa-ivt01.md00.p1.openshiftapps.com -> points to lb -> masocp-zmk6sc-7hvkk-ext-edae0d6909f0bedf.elb.us-east-2.amazonaws.com.
# *.apps.rosa-ivt01.md00.p1.openshiftapps.com -> points to lb > a778573fe118e4659a2926df9b85875a-1425861465.us-east-2.elb.amazonaws.com.


# # 6. Generate certificate
# apiVersion: cert-manager.io/v1
# kind: Certificate
# metadata:
#   name: awsroute53-cert-public
#   namespace: ibm-common-services
# spec:
#   dnsNames:
#     - awsroute53.andrercmaws10.com
#     - '*.awsroute53.andrercmaws10.com'
#     - '*.home.awsroute53.andrercmaws10.com'
#   duration: 8760h0m0s
#   issuerRef:
#     kind: ClusterIssuer
#     name: awsroute53-route53-issuer
#   renewBefore: 720h0m0s
#   secretName: awsroute53-cert-public



# TASK [ibm.mas_devops.suite_dns : Debug information] **************************************************************************************************************************************************************************************************************************************
# ok: [localhost] => {
#     "aws_hosted_zone_create_output": {
#         "changed": true,
#         "cmd": "aws route53 create-hosted-zone --name andrercmaws.com --caller-reference andrercmaws.com\n",
#         "delta": "0:00:01.809864",
#         "end": "2023-05-12 15:28:15.354633",
#         "failed": false,
#         "failed_when_result": false,
#         "msg": "",
#         "rc": 0,
#         "start": "2023-05-12 15:28:13.544769",
#         "stderr": "",
#         "stderr_lines": [],
#         "stdout": "{\n    \"Location\": \"https://route53.amazonaws.com/2013-04-01/hostedzone/Z07728341NKUKGL3X8S43\",\n    \"HostedZone\": {\n        \"Id\": \"/hostedzone/Z07728341NKUKGL3X8S43\",\n        \"Name\": \"andrercmaws.com.\",\n        \"CallerReference\": \"andrercmaws.com\",\n        \"Config\": {\n            \"PrivateZone\": false\n        },\n        \"ResourceRecordSetCount\": 2\n    },\n    \"ChangeInfo\": {\n        \"Id\": \"/change/C06279522VT6NJRC1VOU3\",\n        \"Status\": \"PENDING\",\n        \"SubmittedAt\": \"2023-05-12T18:28:15.497000+00:00\"\n    },\n    \"DelegationSet\": {\n        \"NameServers\": [\n            \"ns-209.awsdns-26.com\",\n            \"ns-1095.awsdns-08.org\",\n            \"ns-2015.awsdns-59.co.uk\",\n            \"ns-756.awsdns-30.net\"\n        ]\n    }\n}",
#         "stdout_lines": [
#             "{",
#             "    \"Location\": \"https://route53.amazonaws.com/2013-04-01/hostedzone/Z07728341NKUKGL3X8S43\",",
#             "    \"HostedZone\": {",
#             "        \"Id\": \"/hostedzone/Z07728341NKUKGL3X8S43\",",
#             "        \"Name\": \"andrercmaws.com.\",",
#             "        \"CallerReference\": \"andrercmaws.com\",",
#             "        \"Config\": {",
#             "            \"PrivateZone\": false",
#             "        },",
#             "        \"ResourceRecordSetCount\": 2",
#             "    },",
#             "    \"ChangeInfo\": {",
#             "        \"Id\": \"/change/C06279522VT6NJRC1VOU3\",",
#             "        \"Status\": \"PENDING\",",
#             "        \"SubmittedAt\": \"2023-05-12T18:28:15.497000+00:00\"",
#             "    },",
#             "    \"DelegationSet\": {",
#             "        \"NameServers\": [",
#             "            \"ns-209.awsdns-26.com\",",
#             "            \"ns-1095.awsdns-08.org\",",
#             "            \"ns-2015.awsdns-59.co.uk\",",
#             "            \"ns-756.awsdns-30.net\"",
#             "        ]",
#             "    }",
#             "}"
#         ]
#     }
# }