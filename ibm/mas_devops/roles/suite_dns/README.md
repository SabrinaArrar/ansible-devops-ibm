suite_dns
=========

This role will manage MAS and DNS provider integration.  IBM Cloud Internet Services is the only supported DNS provider currently. It will also create a secure route (https://cp4d.<mas_domain>) to the CP4D web client using the custom domain used in this role.

### Cloud Internet Services (CIS)
This role will create DNS entries automatically in the CIS service instance.  Two different modes are available:

#### Top Level DNS entries
This mode will create the entries directly using your DNS zone value. It is usually recommended when you have 1x1 relationship between MAS Instance -> CIS service. e.g: mas.whirlpool.com, where the domain matches exactly the CIS zone name.

#### Subdomain DNS entries
This mode will create entries using a subdomain. It allows you to have multiple MAS instances using same CIS service. e.g: dev.mas.whirlpool.com, where 'dev' is the subdomain.

#### Webhook
The Webhook Task will deploy a cert-manager webhook for CIS integration.  The webhook is responsible for managent the certificate challenge requests from letsencrypt and CIS.  This task will also create two ClusterIssuers by default, pointing to Staging & Production LetsEncrypt servers.

!!! note
    There are issues with how cert-manager works with LetsEncrypt staging servers. We end up with a secret for the certificate that doesn't contain the LetsEncrypt CA; but the staging service does not use a well known cert, so we end up with MAS unable to trust the certificates generated by LetsEncrypt staging.

    At present there is no workaround for this, so do not use the LetsEncrypt staging certificate issuer.


Role Variables - General
------------------------
### dns_provider

- **Required**
- Environment Variable: `DNS_PROVIDER`
- Default: None

### mas_instance_id:

- **Required**
- Environment Variable: `MAS_INSTANCE_ID`
- Default: None

### mas_domain

- **Required**
- Environment Variable: `MAS_DOMAIN`
- Default: None

### ocp_ingress

- Optional
- Environment Variable: `OCP_INGRESS`
- Default: None

Role Variables - Cloudflare DNS Integration
-------------------------------------------
### cloudflare_email

- **Required** if `dns_provider` is set to `cloudflare`
- Environment Variable: `CLOUDFLARE_EMAIL`
- Default: None

### cloudflare_apitoken

- **Required** if `dns_provider` is set to `cloudflare`
- Environment Variable: `CLOUDFLARE_APITOKEN`
- Default: None

### cloudflare_zone

- **Required** if `dns_provider` is set to `cloudflare`
- Environment Variable: `CLOUDFLARE_ZONE`
- Default: None

### cloudflare_subdomain

- Optional
- Environment Variable: `CLOUDFLARE_SUBDOMAIN`
- Default: None

Role Variables - IBM Cloud Internet Services DNS Integration
------------------------------------------------------------
### cis_email

- **Required** if `dns_provider` is set to `cis`
- Environment Variable: `CIS_EMAIL`
- Default: None

### cis_apikey

- **Required** if `dns_provider` is set to `cis`
- Environment Variable: `CIS_APIKEY`
- Default: None

### cis_crn

- **Required** if `dns_provider` is set to `cis`
- Environment Variable: `CIS_CRN`
- Default: None

### cis_subdomain

- Optional
- Environment Variable: `CIS_SUBDOMAIN`
- Default: None


Example Playbook
----------------

```yaml
---
- hosts: localhost
  any_errors_fatal: true
  vars:
    mas_instance_id: inst1
    mas_domain: mydomain.com
    cis_crn: xxx
    cis_apikey: xxx
    cis_email: xxx
  roles:
    - ibm.mas_devops.suite_dns
```

License
-------

EPL-2.0
