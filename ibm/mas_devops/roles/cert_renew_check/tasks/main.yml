---
# This role will perform the following:
# Renew the original certificates and check that the newly created certificate gets presented

# 1. Set facts and debug
# -------------------------------------------------------------------------------------------------
- set_fact:
    cert_manager_namespace: "{{ suite_info.resources[0].spec.certManagerNamespace | default('cert-manager', True) }}"


- name: General Debug
  debug:
    msg:
    - "Instance ID ................ {{ mas_instance_id }}"
    - "MAS namespace .............. {{ mas_namespace }}"
    - "MAS Custom Cluster Issuer .. {{ custom_cluster_issuer }}"
    - "Cert-Manager namespace ..... {{ cert_manager_namespace }}"

# 2.1. Renew MAS cert-public and check if it's recreated
# -------------------------------------------------------------------------------------------------
- name: "Lookup original {{mas_instance_id}}-cert-public data"
  kubernetes.core.k8s_info:
    api_version: v1oc
    name: "{{ mas_instance_id }}-cert-public"
    namespace: "{{ mas_namespace }}"
    kind: Secret
  register: publiccert_original_data
  failed_when: publiccert_original_data.resources[0] | length == 0

- name: "Run cmctl renew command"
  shell: cmctl renew {{mas_instance_id}}-cert-public 

- name: "Wait for {{mas_instance_id}}-cert-public to be renew (30s delay)"
  kubernetes.core.k8s_info:
    api_version: v1
    name: "{{mas_instance_id}}-cert-public"
    namespace: "{{ mas_namespace }}"
    kind: Secret
  register: publiccert_new_data
  until:
  - publiccert_new_data.resources[0] is defined
  retries: 5 # approx 5 minutes before we give up
  delay: 30 # 30 Seconds

- name: "Assert new 'tls.crt' in {{mas_instance_id}}-cert-public secret is different from the one prior to renewal"
  block:
    assert:
      that:
        - publiccert_original_data.resources[0].data['tls.crt'] != publiccert_new_data.resources[0].data['tls.crt']
      fail_msg: "Assertion Failed! Original {{mas_instance_id}}-cert-public secret does not match with the recreated one."
      success_msg: "Assertion Passed! Original 'tls.crt' in {{mas_instance_id}}-cert-public secret matches with the new one recreated!"
    rescue:
      - debug:
          msg: "Warning: new secret in {{mas_instance_id}}-cert-public is the same as the one prior to renewal, private key rotation failed"

# 3 Renew all internal certs and check that they're recreated with new details
# -------------------------------------------------------------------------------------------------
- name: Renew internal certs
  include_tasks: tasks/renew_internal_cert.yml
  vars:
    cert_name: "{{ item }}"
  loop:
    - admindashboard
    - adoptionreporter
    - adoptionusageapi
    - catalogapi
    - catalogmgr
    - coreapi
    - coreidp
    - coreidplogin
    - groupsynccoordinator
    - homepage
    - internalapi
    - milestonesapi
    - mobileapi
    - navigator
    - pushnotificationservice
    - scim
    - sendmailapi
    - usersynccoordinator
    - workspacecoordinator
