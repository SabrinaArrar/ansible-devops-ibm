---
# 1. Delete DNS Records from Master Account
# ---------------------------------------------------------------------------------------------------------------------
- name: Set Fact for CIS Instance
  set_fact:
    dns_records_list: []

- name: Master, Fetch Resource Group Id
  ibm.cloudcollection.ibm_resource_group_info:
    name: "{{ master_cis_resource_group }}"
    ibmcloud_api_key: "{{ master_ibmcloud_api_key }}"
  register: rg_info_master

- name: Master, Fetch CIS Instance Resource Id
  ibm.cloudcollection.ibm_cis_info:
    name: "{{ master_cis_resource_name }}"
    ibmcloud_api_key: "{{ master_ibmcloud_api_key }}"
    resource_group_id: "{{ rg_info_master.resource.id }}"
  register: cis_info_master

- name: Master, CIS Domain Info
  ibm.cloudcollection.ibm_cis_domain_info:
    cis_id: "{{ cis_info_master.resource.id }}"
    domain: "{{ masms_base_domain }}"
    ibmcloud_api_key: "{{ master_ibmcloud_api_key }}"
  register: domain_info_master

- name: Master, Fetch DNS Record
  ibm.cloudcollection.ibm_cis_dns_records_info:
    cis_id: "{{ cis_info_master.resource.id }}"
    domain_id: "{{ domain_info_master.resource.id}}"
    ibmcloud_api_key: "{{ master_ibmcloud_api_key }}"
  register: dns_record_info_master

- name: Loop through all DNS records of Master CIS to find customer DNS record
  no_log: yes
  loop: "{{dns_record_info_master.resource.cis_dns_records}}"
  when:
    -  item.name == customer_cis_domain
  set_fact:
    dns_records_list: "{{ dns_records_list + [item.id] }}"

- name: Debug, DNS Records found
  debug:
    msg:
      - "DNS Records ......... {{ dns_records_list }}"

- name: Fail if no resource Id found for DNS Record
  assert:
    that:
      - dns_records_list | length != 0
    fail_msg: "Unable to fetch Resource Id for DNS record {{customer_cis_domain}} "

- name: Delete DNS NS type Record in Master CIS Instance
  loop: "{{ dns_records_list }}"
  ibm.cloudcollection.ibm_cis_dns_record:
    ibmcloud_api_key: "{{ master_ibmcloud_api_key }}"
    id: "{{ item }}"
    state: absent
  register: dns_record_delete

- name: Debug DNS Record Deletion
  debug:
    msg:
      - "Deleted DNS Record ..................... {{ dns_record_delete }}"

- name: Fail if DNS record is not deleted
  loop: "{{ dns_record_delete.results }}"
  assert:
    that:
      - not item.failed and item.changed
    fail_msg: "Unable to delete DNS Record in master CIS"
