---
# Authenticate to CP4D (get Bearer token) via REST API
- name: Lookup for generic-preferences CM to determine Version
  kubernetes.core.k8s_info:
    api_version: v1
    kind: ConfigMap
    name: generic-preferences
    namespace: "{{cpd_namespace}}"
  register: _cpd_generic_preferences

- name: Set CPD Version
  set_fact:
    cpd_version: "{{_cpd_generic_preferences.resources[0].metadata.labels.icpdata_addon_version}}"

- name: Authenticate to CP4D (get Bearer token) via REST API
  block:
    - include_tasks: get-cp4d-route.yml
    - include_tasks: get-cp4d-bearer-token.yml

# Create customized role in CP4D
- name: Create customized role in CP4D
  include_tasks: create-customized-role-in-cp4d.yml
  when: cp4d_access_control_actions is defined and "create_role" in cp4d_access_control_actions

# Create user in CP4D
- name: Create user in CP4D
  include_tasks: create-cp4d-user.yml
  when: cp4d_access_control_actions is defined and "create_user" in cp4d_access_control_actions

# Assign CP4D user to service instance
- name: Assign CP4D user to service instance
  include_tasks: assign-cp4d-user-to-service-instance.yml
  when: cp4d_access_control_actions is defined and "assign_user_to_svc_instance" in cp4d_access_control_actions
