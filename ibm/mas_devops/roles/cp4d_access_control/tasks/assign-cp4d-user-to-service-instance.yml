- name: Set cp4d_user_display_name same as cp4d_username if it's not specified
  set_fact:
    cp4d_user_display_name: "{{ cp4d_username }}"
  when: cp4d_user_display_name is undefined or cp4d_user_display_name == ""

- name: Assign CP4D user {{ cp4d_username }} to Service Instance with ID {{ cp4d_service_instance_id }}
  uri:
    url: "https://{{ cp4d_host }}/zen-data/v2/serviceInstance/users"
    validate_certs: no
    method: POST
    headers:
      Authorization: "Bearer {{ cp4d_bearer_token }}"
      cache-control: "no-cache"
    body_format: "json"
    body: "{ \"users\":[ { \"uid\":\"{{ cp4d_user_userid }}\", \"username\":\"{{ cp4d_username }}\", \"display_name\":\"{{ cp4d_user_display_name }}\", \"role\":\"{{ cp4d_service_instance_user_role }}\" } ], \"serviceInstanceID\":\"{{ cp4d_service_instance_id }}\" }"
    status_code: 200
    timeout: 30
  when: cp4d_service_instance_id is defined and cp4d_service_instance_id != ""
