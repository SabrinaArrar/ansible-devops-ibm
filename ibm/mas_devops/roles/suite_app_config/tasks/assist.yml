---

# 1. Determine CP4D admin login credentials
# -----------------------------------------------------------------------------
- name: "Lookup admin credentials if they haven't been provided already"
  when:
    - cpd_admin_username is not defined or cpd_admin_username == ""
    - cpd_admin_password is not defined or cpd_admin_password == ""
  include_tasks: "lookup-admin-credentials.yml"


# 2. Determine CP4D WD instance API url
# -----------------------------------------------------------------------------
- name: Summary before loading Assist Advanced Setting data
  debug:
    msg:
      - "CP4D Username .................. {{ cpd_admin_username }}"
      - "CP4D Password .................. When not informed, found in 'admin-user-details' secret under '{{ cpd_instance_namespace }}' namespace"
      - "Discovery Instance name ........ {{ cpd_wd_instance_name }}"
      - "MAS config directory ........... {{ mas_config_dir }}"

- name: Load WD instance api Url from wd_url
  when: wd_url is defined and wd_url != ""
  set_fact:
    mas_app_settings_wd_instance_url: "{{ wd_url }}"

- name: Load WD url from configuration directory (only if id is not already defined)
  when:
    - mas_app_settings_wd_instance_url is not defined or mas_app_settings_wd_instance_url == ""
    - cpd_wd_instance_name is defined and cpd_wd_instance_name != ""
    - mas_config_dir is defined and mas_config_dir != ""
  block:
    - set_fact:
        mas_app_settings_wd_instance_url: "{{ lookup('file', mas_config_dir + '/' + cpd_wd_instance_name + '.url') }}"
  rescue:
    - debug:
        msg: "Warning: WD instance api url not found in configuration directory"

- name: "Fail mas_app_settings_wd_instance_url is not provided"
  assert:
    that:
      - mas_app_settings_wd_instance_url is defined and mas_app_settings_wd_instance_url != ""
    fail_msg: "WD instance api url  has not been informed"

- name: WD instance api url used by Assist
  debug:
    msg:
      - "WD instance api url ........... {{ mas_app_settings_wd_instance_url }}"

# 3. Create secret for discovery advanced setting
# -----------------------------------------------------------------------------
- name: Create secret {{ mas_workspace_id }}-assist-watson-discovery-credential
  when:
    - cpd_admin_username is defined or cpd_admin_username != ""
    - cpd_admin_password is defined or cpd_admin_password != ""
  kubernetes.core.k8s:
    state: present
    resource_definition:
      apiVersion: "v1"
      kind: Secret
      metadata:
        name: "{{ mas_workspace_id }}-assist-watson-discovery-credential"
        namespace: "mas-{{ mas_instance_id }}-{{ mas_app_id }}"
      data:
        username: "{{ cpd_admin_username | b64encode }}"
        password: "{{ cpd_admin_password | b64encode }}"


