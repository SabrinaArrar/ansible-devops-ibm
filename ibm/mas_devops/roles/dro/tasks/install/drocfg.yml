---
# Note that the gencfg/main.yml task will actually create the config file,
# this task is just prepping the variables for that one.

- name: "drocfg : Fail if DRO contact information has not been provided"
  assert:
    that:
      - dro_contact.email is defined and dro_contact.email != ""
      - dro_contact.first_name is defined and dro_contact.first_name != ""
      - dro_contact.last_name is defined and dro_contact.last_name != ""
    fail_msg: "dro_contact property is required"

# 1. Lookup the endpoint route
# -----------------------------------------------------------------------------
- name: get ibm-data-reporter route
  k8s_info:
    api_version: route.openshift.io/v1
    kind: Route
    name: ibm-data-reporter
    namespace: redhat-marketplace
  register: dro_route

- name: Assert that ibm-data-reporter route exists
  ansible.builtin.assert:
    that:
      - dro_route is defined
      - dro_route.resources is defined
      - dro_route.resources | length == 1
    fail_msg: "Route not found: ibm-data-reporter"

- name: set dro route for bascfg
  set_fact:
    dro_endpoint_url: "https://{{ dro_route.resources[0].spec.host }}"
  when: (dro_route.resources | length == 1)

# 2. Lookup the DRO API key
# -----------------------------------------------------------------------------
- name: "Create ibm-data-reporter-operator-api SA token secret"
  k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: ibm-data-reporter-operator-api-token
        namespace: redhat-marketplace
        labels:
          secret-owner: ibm-data-reporter-operator-api
        annotations:
            kubernetes.io/service-account.name: ibm-data-reporter-operator-api
      type: kubernetes.io/service-account-token 

- name: get ibm-data-reporter-operator-api secret
  k8s_info:
    kind: Secret
    name: ibm-data-reporter-operator-api-token
    namespace: redhat-marketplace
    label_selectors:
      - secret-owner = ibm-data-reporter-operator-api
  register: token_secret_info

- name: set dro token api for bascfg
  set_fact:
    dro_api_key: "{{ token_secret_info.resources[0].data.token | b64decode }}"
  when: (token_secret_info.resources | length != 0)
