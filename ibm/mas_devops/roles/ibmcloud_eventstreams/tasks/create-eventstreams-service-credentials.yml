# Create IBM Cloud resource key for EventStreams (service id and apikey will be created automatically)

# First, we will check if the target k8s Secret eventstreams_credentials_secret_name already exists
# If it already exists, the creation of resource key and k8s secret will be skipped
- name: "Debug information"
  debug:
    msg:
    - "Event Streams Service Credentials Name ....... {{ eventstreams_credentials_secret_name }}"

- name: Create eventstreams service credentials and k8s secret if the target k8s secret doesn't exist
  block:
    - name: Get the resource id from EventStreams TF output ConfigMap if it's not specified
      block:
        - name: Get the EventStreams TF output ConfigMap
          community.kubernetes.k8s_info:
            api_version: v1
            kind: ConfigMap
            name: "{{ eventstreams_configmap_name }}"
            namespace: "{{ sre_namespace }}"
          register: eventstreams_configmap

        - name: Get the resource id from EventStreams TF output ConfigMap
          set_fact:
            eventstreams_resource_id: "{{ eventstreams_configmap.resources[0].data.id }}"
          when: eventstreams_configmap is defined and eventstreams_configmap.resources is defined and eventstreams_configmap.resources[0].data is defined

      when: eventstreams_resource_id is not defined or eventstreams_resource_id == ""

    - name: Create IBM Cloud resource key for eventstreams (service id and apikey will be created automatically)
      import_role:
        name: ibm.sre_devops.ibmcloud_resource_key
      vars:
        resource_name: "{{ eventstreams_credentials_secret_name }}"
        resource_id: "{{ eventstreams_resource_id }}"
        resource_key_iam_role: "Manager"

    - name: Create k8s Secret for eventstreams service credentials
      no_log: true
      community.kubernetes.k8s:
        state: present
        namespace: "{{ sre_namespace }}"
        definition: "{{ lookup('template', 'templates/eventstreams_credential_secret.yaml.j2') | from_yaml }}"

  when: existing_eventstreams_credentials_secret is undefined or existing_eventstreams_credentials_secret.resources is undefined or existing_eventstreams_credentials_secret.resources | length == 0
