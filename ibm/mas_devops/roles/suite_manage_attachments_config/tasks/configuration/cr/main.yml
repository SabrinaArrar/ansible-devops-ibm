---
# Configuration Mode = cr (Custom Resource)
# -----------------------------------------------------------------------------

# Configure COS bucket for Manage attachments, not needed when using pvc/filestorage
- name: Configure COS/S3 Buckets if required
  include_tasks: "tasks/common/buckets.yml"
  when: mas_manage_attachments_provider in ['ibm', 'aws']

- name: Configure Server Bundles
  include_tasks: "configure-bundles.yml"


# Configure Server bundle properties into Manage Workspace
# -----------------------------------------------------------------------------
- name: "Add the Server Bundle doclinks properties in ManageWorkspace CR"
  kubernetes.core.k8s:
    definition:
      apiVersion: apps.mas.ibm.com/v1
      kind: ManageWorkspace
      metadata:
        name: "{{ manage_workspace_cr_name }}"
        namespace: "mas-{{ mas_instance_id }}-manage"
      spec:
        settings:
          deployment:
            serverBundles: |
              {{ serverBundles }}
  register: managews_sb_output

- name: "Debug information"
  debug:
    msg:
      - "ManageWorkspace Changed ............... {{ managews_sb_output.changed }}"


# Wait for ManageWorkspace CR to reconcile and to be ready
# ---------------------------------------------------------------------------------------------------------------------
- name: "Wait for ManageWorkspace to be ready (120s delay)"
  kubernetes.core.k8s_info:
    api_version: v1
    name: "{{ manage_workspace_cr_name }}"
    namespace: "mas-{{mas_instance_id}}-manage"
    kind: "ManageWorkspace"
    wait: true
    wait_condition:
      status: "True"
      type: Ready
    wait_sleep: 30
    wait_timeout: 200 # before we give up and fall back into the retry loop
  register: app_cr_result
  retries: 60
  delay: 120 # 2 minutes
  until:
    - app_cr_result.resources is defined
    - app_cr_result.resources | length > 0
    - app_cr_result.resources | json_query('[*].status.conditions[?type==`Running`][].reason') | select ('match','Successful') | list | length == 1


# Restart Manage bundle pods to pick up the COS configuration
# ---------------------------------------------------------------------------------------------------------------------
- name: "Lookup Manage bundle pods"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    label_selectors: mas.ibm.com/appType=serverBundle
    namespace: "mas-{{ mas_instance_id }}-manage"
  register: manage_bundle_output

- name: "List Manage bundle pods"
  vars:
    list: []
  set_fact:
    list: "{{ list + [item.metadata.name] }}"
  with_items: "{{ manage_bundle_output.resources }}"
  no_log: true

- debug:
    msg: "Restarting the following Manage bundle pods: {{ list }}"

- name: "Restart Manage bundle pods to apply the attachments configuration"
  failed_when:
    - manage_bundle_output.resources | length == 0
  kubernetes.core.k8s:
    state: absent
    api_version: v1
    kind: Pod
    name: "{{ item.metadata.name }}"
    label_selectors: mas.ibm.com/appType=serverBundle
    namespace: "mas-{{ mas_instance_id }}-manage"
  with_items: "{{ manage_bundle_output.resources  }}"
  loop_control:
    label: "Restarting bundle pod: {{ item.metadata.name }}..."

- name: "Pause for 1 minute before checking bundle pods..."
  pause:
    seconds: 60

- name: "Wait Manage bundle pods to be ready"
  include_tasks: tasks/wait-bundle-pods.yml
