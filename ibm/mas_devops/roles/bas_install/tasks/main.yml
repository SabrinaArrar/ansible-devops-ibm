---

# Check for required facts
# -----------------------------------------------------------------------------
- name: "Fail if BAS persistent storage class has not been provided"
  assert:
    that: bas_persistent_storage_class is defined and bas_persistent_storage_class != ""
    fail_msg: "bas_persistent_storage_class property is required"

- name: "Fail if BAS block storage class has not been provided"
  assert:
    that: bas_meta_storage_class is defined and bas_meta_storage_class != ""
    fail_msg: "bas_meta_storage_class property is required"

- name: "Fail if BAS email has not been provided"
  assert:
    that: bas_contact.email is defined and bas_contact.email != ""
    fail_msg: "bas_contact.email property is required"

- name: "Fail if BAS first name has not been provided"
  assert:
    that: bas_contact.firstName is defined and bas_contact.firstName != ""
    fail_msg: "bas_contact.firstName property is required"

- name: "Fail if BAS email has not been provided"
  assert:
    that: bas_contact.lastName is defined and bas_contact.lastName != ""
    fail_msg: "bas_contact.lastName property is required"


# 1. Generate BAS related passwords if none provided
# -----------------------------------------------------------------------------
- name: "Generate bas_password if none has been provided"
  when: bas_password is not defined or bas_password == ""
  set_fact:
    bas_password: "{{ lookup('password', '/dev/null length=15 chars=ascii_letters') }}"
  no_log: "{{ bas_password is defined }}"

- name: "Generate bas_grafana_password if none has been provided"
  when: bas_grafana_password is not defined or bas_grafana_password == ""
  set_fact:
    bas_grafana_password: "{{ lookup('password', '/dev/null length=15 chars=ascii_letters') }}"
  no_log: "{{ bas_grafana_password is defined }}"


# 2. Provide Debug information
# -----------------------------------------------------------------------------
- name: "Debug information"
  debug:
    msg:
      - "BAS Namespace ...................... {{ bas_namespace }}"
      - "BAS Persistent Storage Class........ {{ bas_persistent_storage_class }}"
      - "BAS Metadata Storage Class ......... {{ bas_meta_storage_class }}"


# 3. Create BAS project
# -----------------------------------------------------------------------------
- name: "Create namespace"
  community.kubernetes.k8s:
    api_version: v1
    kind: Namespace
    name: '{{ bas_namespace }}'


# 4. Deploy BAS subscription and Operator Group
# -----------------------------------------------------------------------------
- name: "Create operator group"
  community.kubernetes.k8s:
    definition: "{{ lookup('template', 'templates/operator-group.yaml') }}"
    wait: yes
    wait_timeout: 60 #subsequent tasks will fail if the CRD isn't fully created

- name: "Create subscription"
  community.kubernetes.k8s:
    definition: "{{ lookup('template', 'templates/subscription.yaml') }}"
    wait: yes
    wait_timeout: 300
    wait_condition:
      type: 'CatalogSourcesUnhealthy'
      status: "False"

- name: "Wait until the analyticsproxies CRD is available"
  community.kubernetes.k8s_info:
    api_version: apiextensions.k8s.io/v1
    name: "analyticsproxies.bas.ibm.com"
    kind: CustomResourceDefinition
    wait: yes
    wait_sleep: 10
    wait_timeout: 300 # 5 mins until we give up waiting for the CRD to get into the expected state
    wait_condition:
      type: NamesAccepted
      status: "True"
  register: bas_crd_info
  retries: 120 # ~approx 10 minutes before we give up waiting for the CRD to be created
  delay: 5 # seconds
  until:
    - bas_crd_info.resources is defined
    - bas_crd_info.resources | length > 0


# 5. Create BAS User Secret
# -----------------------------------------------------------------------------
- name: Create BAS User Secret
  community.kubernetes.k8s:
    definition:
      apiVersion: v1
      kind: Secret
      type: Opaque
      metadata:
        name: database-credentials
        namespace: "{{ bas_namespace}}"
      stringData:
        db_username: "{{ bas_username }}"
        db_password: "{{ bas_password }}"
  no_log: "{{ bas_password is defined }}"


# 6. Create Grafana User Secret
# -----------------------------------------------------------------------------
- name: Create Grafana User Secret
  community.kubernetes.k8s:
    definition:
      apiVersion: v1
      kind: Secret
      type: Opaque
      metadata:
        name: grafana-credentials
        namespace: "{{ bas_namespace }}"
      stringData:
        bas_grafana_username: "{{ bas_grafana_username }}"
        bas_grafana_password: "{{ bas_grafana_password }}"
  no_log: "{{ bas_grafana_password is defined }}"


# 7. Create BAS AnalyticsProxy
# -----------------------------------------------------------------------------
- name: "Create BAS AnalyticsProxy"
  community.kubernetes.k8s:
    definition: "{{ lookup('template', 'templates/analyticsproxy.yaml') }}"


# 8. BAS Install Reliability Hack
# -----------------------------------------------------------------------------
# BAS is VERY unreliable
# Instead of waiting for the AnalyticsProxy status to report success as we
# normally would, we need to do some hacky steps to try to handle known problems
# with the BAS operator that the team are not fixing.
#
# If, after 20 minutes, the createcluster job still exists, then we will delete
# it causing the BAS operator to try again.
#
# Note that when the job has successfully completed, the BAS operator deletes
# the job entirely, so there is no visibility of this job on a good path install.
# If the job merely exists at this stage then there is a problem with the
# install, so we don't need to check the state of the job, only that it exists.
#
# The BAS operator will now recreate the job, and usually it works on the second
# attempt.
#
# We now resume the normal deployment flow, and will monitor the AnalyticsProxy
# until it's status.phase is set to "Ready"

- name: "Check the initial status of the AnalyticsProxy"
  community.kubernetes.k8s_info:
    api_version: bas.ibm.com/v1
    name: analyticsproxy
    namespace: "{{ bas_namespace }}"
    kind: AnalyticsProxy
  register: bas_cr_lookup
  until:
    - bas_cr_lookup.resources is defined and bas_cr_lookup.resources | length == 1
    - bas_cr_lookup.resources[0].status is defined
    - bas_cr_lookup.resources[0].status.phase is defined
  retries: 15 # approx 15 minutes before we give up waiting for status.phase to be initialized
  delay: 60 # 1 minute

- name: "Pause for 20 minutes to wait for the createcluster job to complete"
  when: bas_cr_lookup.resources[0].status.phase != 'Ready'
  pause:
    minutes: 20

- name: "Look up the status of the createcluster Job"
  when: bas_cr_lookup.resources[0].status.phase != 'Ready'
  community.kubernetes.k8s_info:
    api_version: batch/v1
    name: createcluster
    namespace: "{{ bas_namespace }}"
    kind: Job
  register: bas_createcluster_job_lookup

- name: "Delete the createcluster job if it's still present"
  when:
    - bas_cr_lookup.resources[0].status.phase != 'Ready'
    - bas_createcluster_job_lookup.resources | length == 1
  community.kubernetes.k8s:
    api_version: batch/v1
    name: createcluster
    namespace: "{{ bas_namespace }}"
    kind: Job
    state: absent


# 9. Wait for AnalyticsProxy to be complete
# -----------------------------------------------------------------------------
- name: "Wait for AnalyticsProxy to be ready (60s delay)"
  community.kubernetes.k8s_info:
    api_version: bas.ibm.com/v1
    name: analyticsproxy
    namespace: "{{ bas_namespace }}"
    kind: AnalyticsProxy
  register: bas_cr_lookup
  until:
    - bas_cr_lookup.resources is defined and bas_cr_lookup.resources | length == 1
    - bas_cr_lookup.resources[0].status is defined
    - bas_cr_lookup.resources[0].status.phase is defined
    - bas_cr_lookup.resources[0].status.phase == 'Ready'
  retries: 45 # approx 45 minutes before we give up
  delay: 60 # 1 minute

- name: "Create BAS Generate Key"
  community.kubernetes.k8s:
    definition: "{{ lookup('template', 'templates/generateKey.yaml') }}"


# 10. Wait for GenerateKey to be complete
# -----------------------------------------------------------------------------
- name: "Wait for GenerateKey to be ready (60s delay)"
  community.kubernetes.k8s_info:
    api_version: bas.ibm.com/v1
    name: bas-api-key
    namespace: "{{bas_namespace}}"
    kind: GenerateKey
  register: bas_gk_result
  until:
    - bas_gk_result.resources is defined and bas_gk_result.resources | length == 1
    - bas_gk_result.resources[0].status is defined
    - bas_gk_result.resources[0].status.phase is defined
    - bas_gk_result.resources[0].status.phase == 'Ready'
  retries: 30 # approx 30 minutes before we give up
  delay: 60 # 1 minute


# 11. MAS Config
# -----------------------------------------------------------------------------
- include_tasks: tasks/bascfg.yml
  when:
    - mas_instance_id is defined
    - mas_instance_id != ""
    - mas_config_dir is defined
    - mas_config_dir != ""

# 12. BAS deployment details
# -----------------------------------------------------------------------------
- name: "BAS Deployment details"
  debug:
    msg:
      - "BAS Namespace ...................... {{ bas_namespace }}"
      - "BAS API Key ........................ Found in 'bas_api_key' secret under '{{ bas_namespace }}' namespace"
      - "BAS Username/Password .............. Found in 'database-credentials' secret under '{{ bas_namespace }}' namespace"
      - "BAS Grafana Username/Password ...... Found in 'grafana-credentials' secret under '{{ bas_namespace }}' namespace"
      - "BAS E-mail ......................... {{ bas_contact.email }}"
      - "BAS First Name ..................... {{ bas_contact.firstName }}"
      - "BAS Last Name ...................... {{ bas_contact.lastName }}"
