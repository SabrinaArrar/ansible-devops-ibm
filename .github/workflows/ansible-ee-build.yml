name: Build Ansible Execution Environment Image
on:
  push:
    branches:
      - '**'
    tags-ignore:
      - '**'
jobs:
  ansible-ee-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2.3.1
        # Without this option, we don't get the tag information
        with:
          fetch-depth: 0

      - name: Initialise the build system
        run: |
          chmod u+x $GITHUB_WORKSPACE/build/bin/*.sh
          $GITHUB_WORKSPACE/build/bin/initbuild.sh
          source $GITHUB_WORKSPACE/build/bin/.functions.sh
        
      - name: Build the Ansible execution environment
        run: |
          docker login --username "${{ secrets.REDHAT_USERNAME }}" --password "${{ secrets.REDHAT_PASSWORD }}" registry.redhat.io
          $GITHUB_WORKSPACE/build/bin/build-execution-environment.sh

      - name: Push the container image
        id: docker-push
        run: |
          docker tag ibmmas/ansible-devops-ee quay.io/ibmmas/ansible-devops-ee:${{ env.DOCKER_TAG }}
          docker images
          docker login --username "${{ secrets.QUAYIO_USERNAME }}" --password "${{ secrets.QUAYIO_PASSWORD }}" quay.io
          docker push quay.io/ibmmas/ansible-devops-ee:${{ env.DOCKER_TAG }}

      - name: Push the container image (master)
        id: docker-push-master
        if: github.ref == 'refs/heads/master'
        run: |
          docker tag ibmmas/ansible-devops-ee quay.io/ibmmas/ansible-devops-ee:master
          docker images
          docker push quay.io/ibmmas/ansible-devops-ee:master

      - name: Push the container image (latest)
        id: docker-push-latest
        if: github.event_name == 'release'
        run: |
          docker tag ibmmas/ansible-devops-ee quay.io/ibmmas/ansible-devops-ee:latest
          docker images
          docker push quay.io/ibmmas/ansible-devops-ee:latest
            --enableRetired

