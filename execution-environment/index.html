<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://ibm-mas.github.io/ansible-devops/execution-environment/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Execution Environment - MAS Devops Collection</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Execution Environment";
        var mkdocs_page_input_path = "execution-environment.md";
        var mkdocs_page_url = "/ansible-devops/execution-environment/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> MAS Devops Collection
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">Execution Environment</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#execution-environment-image">Execution Environment Image</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#how-to-setup-anisble-automation-platform">How to setup Anisble Automation Platform</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#organization">Organization</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#inventory">Inventory</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#execution-environment_1">Execution Environment</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#credentials">Credentials</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#project">Project</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#job-templates">Job Templates</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#workflow-templates">Workflow Templates</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#how-to-run-a-job">How to run a Job</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#examples-of-playbooks">Examples of playbooks</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#oneclick_coreyml">oneclick_core.yml</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#ocp-provision">ocp-provision</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#backuprestore">backup/restore</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#troubleshooting">Troubleshooting</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#helpful-links">Helpful Links</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#cant-see-all-output-in-log-file">Can't see all output in log file</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#my-playbook-or-updated-playbook-cant-be-found">My playbook or updated playbook can't be found</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#job-failed-can-i-re-launch-it">Job failed can I re-launch it?</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#how-to-provide-supporting-files">How to provide supporting files?</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#how-do-i-set-environment-variables">How do I set environment variables?</a>
    </li>
        </ul>
    </li>
    </ul>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Playbooks</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../playbooks/ocp/">OCP</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../playbooks/cp4d/">Install Cloud Pak For Data</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../playbooks/oneclick-core/">Install Core</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../playbooks/oneclick-aibroker/">Add AIBroker</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../playbooks/oneclick-iot/">Add IoT</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../playbooks/oneclick-manage/">Add Manage</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../playbooks/oneclick-monitor/">Add Monitor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../playbooks/oneclick-optimizer/">Add Optimizer</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../playbooks/oneclick-predict/">Add Predict</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../playbooks/oneclick-visualinspection/">Add Visual Inspection</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../playbooks/oneclick-update/">Update</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../playbooks/oneclick-upgrade/">Upgrade</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../playbooks/uninstall-core/">Uninstall Core</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../playbooks/backup-restore/">Backup & Restore</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Roles: OCP Mgmt</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/ocp_cluster_monitoring/">ocp_cluster_monitoring</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/ocp_config/">ocp_config</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/ocp_deprovision/">ocp_deprovision</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/ocp_efs/">ocp_efs</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/ocp_github_oauth/">ocp_github_oauth</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/ocp_login/">ocp_login</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/ocp_node_config/">ocp_node_config</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/ocp_provision/">ocp_provision</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/ocp_roks_upgrade_registry_storage/">ocp_roks_upgrade_registry_storage</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/ocp_upgrade/">ocp_upgrade</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/ocp_verify/">ocp_verify</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Roles: Dependency Mgmt</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/appconnect/">appconnect</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/aws_bucket_access_point/">aws_bucket_access_point</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/aws_documentdb_user/">aws_documentdb_user</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/aws_policy/">aws_policy</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/aws_route53/">aws_route53</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/aws_user_creation/">aws_user_creation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/aws_vpc/">aws_vpc</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/cert_manager/">cert_manager</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/cis/">cis</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/common_services/">common-services</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/configure_manage_eventstreams/">configure_manage_eventstreams</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/cos/">cos</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/cos_bucket/">cos_bucket</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/cp4d_admin_pwd_update/">cp4d_admin_pwd_update</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/cp4d/">cp4d</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/cp4d_service/">cp4d_service</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/db2/">db2</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/dro/">dro</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/eck/">eck</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/grafana/">grafana</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/ibm_catalogs/">ibm_catalogs</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/kafka/">kafka</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/nvidia_gpu/">nvidia_gpu</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/mongodb/">mongodb</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/ocs/">ocs</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/sls/">sls</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/turbonomic/">turbonomic</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/uds/">uds</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Roles: Image Mirroring</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/mirror_case_prepare/">mirror_case_prepare</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/mirror_extras_prepare/">mirror_extras_prepare</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/mirror_images/">mirror_images</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/mirror_ocp/">mirror_ocp</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/ocp_contentsourcepolicy/">ocp_contentsourcepolicy</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/ocp_simulate_disconnected_network/">ocp_simulate_disconnected_network</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/registry/">registry</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Roles: Suite Mgmt</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/suite_app_config/">suite_app_config</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/suite_app_install/">suite_app_install</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/suite_app_uninstall/">suite_app_uninstall</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/suite_app_upgrade/">suite_app_upgrade</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/suite_app_rollback/">suite_app_rollback</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/suite_app_backup_restore/">suite_app_backup_restore</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/suite_certs/">suite_certs</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/suite_config/">suite_config</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/suite_db2_setup_for_manage/">suite_db2_setup_for_manage</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/suite_dns/">suite_dns</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/suite_install/">suite_install</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/suite_manage_attachments_config/">suite_manage_attachments_config</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/suite_manage_birt_report_config/">suite_manage_birt_report_config</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/suite_manage_bim_config/">suite_manage_bim_config</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/suite_manage_customer_files_config/">suite_manage_customer_files_config</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/suite_manage_import_certs_config/">suite_manage_import_certs_config</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/suite_manage_load_dbc_scripts/">suite_manage_load_dbc_scripts</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/suite_manage_logging_config/">suite_manage_logging_config</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/suite_manage_pvc_config/">suite_manage_pvc_config</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/suite_uninstall/">suite_uninstall</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/suite_upgrade/">suite_upgrade</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/suite_rollback/">suite_rollback</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/suite_verify/">suite_verify</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/suite_backup_restore/">suite_backup_restore</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Roles: Utilities</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/ansible_version_check/">ansible_version_check</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/entitlement_key_rotation/">entitlement_key_rotation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/gencfg_jdbc/">gencfg_jdbc</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/gencfg_watsonstudio/">gencfg_watsonstudio</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/gencfg_workspace/">gencfg_workspace</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/install_operator/">install_operator</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../roles/gencfg_mongo/">gencfg_mongo</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">MAS Devops Collection</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Execution Environment</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/ibm-mas/ansible-devops/blob/master/docs/execution-environment.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="execution-environment">Execution Environment<a class="headerlink" href="#execution-environment" title="Permanent link"></a></h1>
<p>Details on the Red Hat Ansible Automation Platform Execution Environment for ansible-devops.</p>
<h2 id="execution-environment-image">Execution Environment Image<a class="headerlink" href="#execution-environment-image" title="Permanent link"></a></h2>
<p>The execution environment image for ansible-devops builds on the latest ansible-automation-platform-24/ee-supported-rhel9 image from Red Hat that provides the ansible-core and Red Hat supported collections. The ansible-devops-ee image includes the <code>ibm.mas_devops</code> collection and all required client libraries to function.</p>
<p>The image is uploaded to quay.io at <a href="https://quay.io/ibmmas/ansible-devops-ee">quay.io/ibmmas/ansible-devops-ee</a></p>
<h2 id="how-to-setup-anisble-automation-platform">How to setup Anisble Automation Platform<a class="headerlink" href="#how-to-setup-anisble-automation-platform" title="Permanent link"></a></h2>
<h3 id="organization">Organization<a class="headerlink" href="#organization" title="Permanent link"></a></h3>
<p>An Organization is a logical collection of Users, Teams, Projects, and Inventories, and is the highest level in the automation controller object hierarchy. Create an organization if you don't already have one:</p>
<p><img alt="org" src="../images/organization.png" /></p>
<h3 id="inventory">Inventory<a class="headerlink" href="#inventory" title="Permanent link"></a></h3>
<p>An Inventory is a collection of hosts against which jobs may be launched, the same as an Ansible inventory file. The <code>ibm.mas_devops</code> collection runs against localhost so an Inventory of hosts just requires the one host of <code>localhost</code> to be added but this might be important for any other roles you might want to execute outside of this collection but within this organization. Create an initial inventory if one doesn't exist yet:</p>
<p><img alt="Inventory" src="../images/inventory.png" /></p>
<p>Ensure that the host entry has the following variables set to ensure a local connection:</p>
<p><img alt="Inventroy" src="../images/inventory-2.png" /></p>
<h3 id="execution-environment_1">Execution Environment<a class="headerlink" href="#execution-environment_1" title="Permanent link"></a></h3>
<p>In Ansible Automation Platform (AAP) you can setup a new Execution Environment by specifying the image and tag. You can use either a versioned tag or latest such as <code>quay.io/ibmmas/ansible-devops-ee:latest</code> or <code>quay.io/ibmmas/ansible-devops-ee:24.0.0</code></p>
<p><img alt="execution-env" src="../images/execution-env.png" /></p>
<h3 id="credentials">Credentials<a class="headerlink" href="#credentials" title="Permanent link"></a></h3>
<p>To use your own playbooks that are in source control management (SCM) you will need to setup credentials in AAP to fetch these (unless the repo is public). An example of this is providing a GitHub fine-grained access token which will just allow the token to read the contents of the repo.</p>
<p><img alt="creds-1" src="../images/credentials.png" /></p>
<p>¡<a href="../images/credentials-2.png">creds-2</a></p>
<p>Depending on if you have an exiting cluster or not, then you will need to setup the <code>OpenShift or Kubernetes API Bearer Token</code> credentials to access the Openshift cluster, which will be required on any Jobs that interect with the cluster.</p>
<h3 id="project">Project<a class="headerlink" href="#project" title="Permanent link"></a></h3>
<p>Once you have the execution environment setup you can now create a Project that will point to the source of your playbooks. It is recommended that you use your own source of playbooks rather than the playbooks contained in this repo, to give you full control over what is run to suit your needs. Create the Project and set the Execution Environment to be the one created eariler, and set the source control details and credentials needed for AAP to read your playbooks.</p>
<p><img alt="project" src="../images/Project.png" /></p>
<h3 id="job-templates">Job Templates<a class="headerlink" href="#job-templates" title="Permanent link"></a></h3>
<p>The Job Templates are what each Job is launched from and contains the details of what Playbook to execute. The Job is the executed instance of a Template that contains any specific values required.</p>
<p>To create the Template add the Inventory, Project and Execution Environment setup previously. The playbook dropdown should contain all the playbooks that are found in your SCM (if no playbooks are shown then check the <a href="#troubleshooting">Troubleshooting</a> section). At this point you can choose any other settings that you might want to use, and it is recommended to check the AAP <a href="https://docs.redhat.com/en/documentation/red_hat_ansible_automation_platform/2.5">documentation</a> on this.</p>
<p><img alt="template-1" src="../images/template-1.png" /></p>
<p>Once the Job template is created then you can click on the created template and navigate to <code>Survey</code>. This is where you can provide any secure variables for your playbook that you don't want to keep in source control. You can choose the questions to ask and what type the variable should be. The variable name should make the variable name that the corresponding role is expecting.</p>
<p><img alt="survey" src="../images/survey.png" /></p>
<p><img alt="survey-2" src="../images/survey-2.png" /></p>
<p>Finally, ensure that the Survey is Enabled:</p>
<p><img alt="survey-3" src="../images/survey-3.png" /></p>
<h3 id="workflow-templates">Workflow Templates<a class="headerlink" href="#workflow-templates" title="Permanent link"></a></h3>
<p>The Workflow Templates allow you to configure a number of job templates (or other workflow templates) together. This can be useful when you want to use other roles from other collections (see the AAP Certified Content <a href="https://access.redhat.com/support/articles/ansible-automation-platform-certified-content">here</a>) as well as the ansible-devops collection. For example, you might want to run some AWS or VMWare roles to configure resources after or before the ansible-devops collection roles.</p>
<h2 id="how-to-run-a-job">How to run a Job<a class="headerlink" href="#how-to-run-a-job" title="Permanent link"></a></h2>
<p>Now you have the Job Template setup, you can launch the Job from that Template. Navigate to the Templates view and click the launch icon:</p>
<p><img alt="job" src="../images/job-1.png" /></p>
<p>Enter any survey questions you have configured:</p>
<p><img alt="job-2" src="../images/job-2.png" /></p>
<p>The Job now launches and you can see the output. The list of executing and executed jobs can be seen from the Jobs seciton</p>
<p><img alt="job-3" src="../images/job-3.png" /></p>
<h2 id="examples-of-playbooks">Examples of playbooks<a class="headerlink" href="#examples-of-playbooks" title="Permanent link"></a></h2>
<p>You can use the ansbile-devops <a href="https://github.com/ibm-mas/ansible-devops/tree/master/ibm/mas_devops/playbooks">playbooks</a> as a reference on how to setup your own playbooks. Defining your own playbooks gives you full control over what roles can be run and also include your own roles or roles from the supported Red Hat collection.</p>
<p>If you are using the <a href="https://github.com/ibm-mas/ansible-devops/tree/master/ibm/mas_devops/playbooks">playbooks</a> as a starting point then please note the following changes that would be required:</p>
<ul>
<li>Remove any pre_tasks related to environment variables</li>
<li>Remove any lookups of environment variables from the playbook</li>
</ul>
<h3 id="oneclick_coreyml">oneclick_core.yml<a class="headerlink" href="#oneclick_coreyml" title="Permanent link"></a></h3>
<p>An example of this is taking the <code>oneclick_core.yml</code> playbook:</p>
<pre><code class="language-yaml">---
- hosts: localhost
  any_errors_fatal: true
  vars:
    # Install SLS
    # Note: We need to create some intermediate variables to construct sls_mongodb_cfg_file,
    # This is the only reason they feature here, all the roles that use these variables would also
    # load them directly from the same environment variables if they were not defined here.
    mas_config_dir: &quot;{{ lookup('env', 'MAS_CONFIG_DIR') }}&quot;
    mongodb_namespace: &quot;{{ lookup('env', 'MONGODB_NAMESPACE') | default('mongoce', True) }}&quot;
    sls_mongodb_cfg_file: &quot;{{ mas_config_dir }}/mongo-{{ mongodb_namespace }}.yml&quot;

    # Core Services Configuration
    mas_channel: &quot;{{ lookup('env', 'MAS_CHANNEL') | default('9.0.x', true) }}&quot;

    # Workspace Configuration
    mas_workspace_name: &quot;{{ lookup('env', 'MAS_WORKSPACE_NAME') | default('MAS Development', true) }}&quot;
    mas_workspace_id: &quot;{{ lookup('env', 'MAS_WORKSPACE_ID') | default('masdev', true) }}&quot;

  pre_tasks:
    # For the full set of supported environment variables refer to the playbook documentation
    - name: Check for required environment variables
      assert:
        that:
          # IBM
          - lookup('env', 'IBM_ENTITLEMENT_KEY') != &quot;&quot;
          # MAS
          - lookup('env', 'MAS_INSTANCE_ID') != &quot;&quot;
          - lookup('env', 'MAS_CONFIG_DIR') != &quot;&quot;
          # SLS
          - (lookup('env', 'SLS_LICENSE_ID') != &quot;&quot; and lookup('env', 'SLS_LICENSE_FILE') != &quot;&quot;) or
            (lookup('env', 'SLS_ENTITLEMENT_FILE') != &quot;&quot;)
          # DRO
          - lookup('env', 'DRO_CONTACT_EMAIL') != &quot;&quot;
          - lookup('env', 'DRO_CONTACT_FIRSTNAME') != &quot;&quot;
          - lookup('env', 'DRO_CONTACT_LASTNAME') != &quot;&quot;
        fail_msg: &quot;One or more required environment variables are not defined&quot;

  roles:
    # 1. Install cluster-scoped dependencies (e.g. Cert-Manager, Operator Catalogs) &amp; Grafana
    - ibm.mas_devops.ibm_catalogs
    - ibm.mas_devops.cert_manager
    - ibm.mas_devops.grafana

    # 2. Install MongoDb
    - ibm.mas_devops.mongodb

    # 3. Install SLS
    # Set sls_url, sls_tls_crt_local_file_path, sls_registration_key variables to skip install and set up SLSCfg for
    # an existing installation of SLS
    - ibm.mas_devops.sls

    # 4 Install DRO
    - ibm.mas_devops.dro

    # 5. Generate a Workspace
    - ibm.mas_devops.gencfg_workspace

    # 6. Install &amp; configure MAS
    - ibm.mas_devops.suite_dns
    - ibm.mas_devops.suite_certs
    - ibm.mas_devops.suite_install
    - ibm.mas_devops.suite_config
    - ibm.mas_devops.suite_verify
</code></pre>
<p>and changing it to look like the following:</p>
<pre><code class="language-yaml">---
- name: &quot;oneclick-core&quot;
  hosts: localhost
  any_errors_fatal: true
  vars:
    mas_config_dir: &quot;/tmp&quot;
    mongodb_namespace: &quot;mongoce&quot;
    sls_mongodb_cfg_file: &quot;{{ mas_config_dir }}/mongo-{{ mongodb_namespace }}.yml&quot;

    # Core Services Configuration
    mas_channel: &quot;9.0.x&quot;

    mas_instance_id: &quot;aap1&quot;

    # Workspace Configuration
    mas_workspace_name: &quot;MAS Development&quot;
    mas_workspace_id: &quot;masdev&quot;

    entitlement_file: &quot;license_file/entitlement.lic&quot;

    dro_contact:
      email: &quot;whitfiea@uk.ibm.com&quot;
      first_name: &quot;Andrew&quot;
      last_name: &quot;Whitfield&quot;

  roles:
    # 1. Install cluster-scoped dependencies (e.g. Cert-Manager, Operator Catalogs) &amp; Grafana
    - ibm.mas_devops.ibm_catalogs
    - ibm.mas_devops.cert_manager

    # 2. Install MongoDb
    - ibm.mas_devops.mongodb

    # 3. Install SLS
    - ibm.mas_devops.sls

    # 4 Install DRO
    - ibm.mas_devops.dro

    # 5. Generate a Workspace
    - ibm.mas_devops.gencfg_workspace

    # 6. Install &amp; configure MAS
    - ibm.mas_devops.suite_install
    - ibm.mas_devops.suite_config
    - ibm.mas_devops.suite_verify
</code></pre>
<p>The above has removed any environment variable lookups in the playbook itself, and also modified the roles so it doesn't run the <code>grafana</code> role.</p>
<h3 id="ocp-provision">ocp-provision<a class="headerlink" href="#ocp-provision" title="Permanent link"></a></h3>
<p>If you need to set an environment variable then you can do this in the playbook as well, this would be needed in certain cases such as setting the AWS cli details. The <code>aws_access_key_id</code> and <code>aws_secret_access_key</code> are variables set by AAP as a result of the Survey questions:</p>
<pre><code class="language-yaml">---
- name: &quot;ocp-provision&quot;
  hosts: localhost
  vars:
    cluster_name: testcluster
    cluster_type: rosa
    ocp_version: 4.14.35
    rosa_compute_nodes: 3

  environment: 
    AWS_DEFAULT_REGION: us-east-1
    AWS_ACCESS_KEY_ID: &quot;{{ aws_access_key_id }}&quot;
    AWS_SECRET_ACCESS_KEY: &quot;{{ aws_secret_access_key }}&quot;

  roles:
    # 1. Provision the ROSA cluster
    - ibm.mas_devops.ocp_provision

    # 2. Login and verify the cluster is ready
    - ibm.mas_devops.ocp_login
    - ibm.mas_devops.ocp_verify

    # 3. Set up storage classes
    - ibm.mas_devops.ocp_efs
</code></pre>
<h3 id="backuprestore">backup/restore<a class="headerlink" href="#backuprestore" title="Permanent link"></a></h3>
<p>The backup and restore tasks and playbooks provided in the <code>ibm.mas_devops</code> collection has a number of differences with other roles/playbooks that can make creating the playbook difficult. The following playbook is an example of how a backup for core playbook can be written to work with AAP, along with a rclone.conf.j2 file that should be stored in the same location as the playbook in your SCM. The playbook needs to set both the <code>environment</code> so that the <code>ansible_env</code> var is set, and for task vars to be set to override the common_vars that are looking for environment variables on the local controller (note that <code>environment</code> does not update the local controller environment so lookups using the ansible builtin <code>env</code> won't pick up those values).</p>
<p>This playbook requires the following survey questions to be setup:</p>
<pre><code class="language-yaml">{
  &quot;aws_access_key_id&quot;: &quot;$encrypted$&quot;,
  &quot;aws_secret_access_key&quot;: &quot;$encrypted$&quot;,
  &quot;ocp_token&quot;: &quot;$encrypted$&quot;,
  &quot;ocp_server&quot;: &quot;https://api.your_ocp_cluster:6443&quot;
}
</code></pre>
<pre><code class="language-yaml">---
- name: &quot;Backup/Restore MAS Core&quot;
  hosts: localhost
  any_errors_fatal: true

  vars:
    # Define the target for backup/restore
    mas_instance_id: aap1

    # Define what action to perform
    masbr_action: backup

    # Define storage type
    masbr_storage_type: cloud
    masbr_storage_cloud_rclone_file: rclone.conf
    masbr_storage_cloud_rclone_name: masbr
    masbr_storage_cloud_bucket: mas-backup

    # Define what to backup/restore
    masbr_job_component:
      name: &quot;core&quot;
      instance: &quot;{{ mas_instance_id }}&quot;
      namespace: &quot;mas-{{ mas_instance_id }}-core&quot;

    # Configure path to backup_restore tasks that should be present in the execution environment
    role_path: &quot;/usr/share/ansible/collections/ansible_collections/ibm/mas_devops/roles/suite_backup_restore&quot;

  # Set here to get into ansible_env
  environment:
    MASBR_STORAGE_TYPE: cloud
    MASBR_STORAGE_CLOUD_RCLONE_FILE: rclone.conf
    MASBR_STORAGE_CLOUD_RCLONE_NAME: masbr
    MASBR_STORAGE_CLOUD_BUCKET: mas-backup

  pre_tasks:
    - name: &quot;Asserts aws_access_key_id secret defined&quot;
      assert: 
        that: aws_access_key_id is defined
        fail_msg: &quot;aws_access_key_id not defined&quot;

    - name: &quot;Asserts aws_secret_access_key secret defined&quot;
      assert: 
        that: aws_secret_access_key is defined
        fail_msg: &quot;aws_secret_access_key not defined&quot;

    # Template out the rclone.conf so no credentials are stored in git
    - name: &quot;Create rclone.conf&quot;
      template:
        src: &quot;{{ masbr_storage_cloud_rclone_file }}.j2&quot;
        dest: &quot;{{ masbr_storage_cloud_rclone_file }}&quot;

  roles:
    - ibm.mas_devops.ocp_login

  tasks:

    # Common checks before run tasks
    # -------------------------------------------------------------------------
    - name: &quot;Before run tasks&quot;
      include_tasks:
        file: &quot;{{ role_path }}/../../common_tasks/backup_restore/before_run_tasks.yml&quot;
      vars:
        _job_type: &quot;{{ masbr_action }}&quot;
        masbr_storage_type: cloud
        masbr_storage_cloud_rclone_file: rclone.conf
        masbr_storage_cloud_rclone_name: masbr
        masbr_storage_cloud_bucket: mas-backup

    # Create k8s Job to run backup/restore tasks
    # -------------------------------------------------------------------------
    - name: &quot;Create k8s Job to run {{ masbr_action }} tasks&quot;
      when: masbr_create_task_job
      include_tasks: 
        file: &quot;{{ role_path }}/../../common_tasks/backup_restore/create_run_tasks_job.yml&quot;
      vars:
        _rt_playbook_name: &quot;br_core&quot;
        _rt_env:
          - name: &quot;MASBR_ACTION&quot;
            value: &quot;{{ masbr_action }}&quot;
          - name: &quot;MASBR_JOB_VERSION&quot;
            value: &quot;{{ masbr_job_version }}&quot;
          - name: &quot;MAS_INSTANCE_ID&quot;
            value: &quot;{{ mas_instance_id }}&quot;
        masbr_storage_type: cloud
        masbr_storage_cloud_rclone_file: rclone.conf
        masbr_storage_cloud_rclone_name: masbr
        masbr_storage_cloud_bucket: mas-backup

    # Run backup/restore tasks locally
    # -------------------------------------------------------------------------
    - name: &quot;Run {{ masbr_action }} tasks&quot;
      when: not masbr_create_task_job
      block:
        - name: &quot;MongoDB: {{ masbr_action }}&quot;
          include_role:
            name: ibm.mas_devops.mongodb
          vars:
            mongodb_action: &quot;{{ masbr_action }}&quot;
            mas_app_id: &quot;core&quot;
            masbr_storage_type: cloud
            masbr_storage_cloud_rclone_file: rclone.conf
            masbr_storage_cloud_rclone_name: masbr
            masbr_storage_cloud_bucket: mas-backup

        - name: &quot;MAS Core namespace: {{ masbr_action }}&quot;
          include_role:
            name: ibm.mas_devops.suite_backup_restore
          vars:
            masbr_storage_type: cloud
            masbr_storage_cloud_rclone_file: rclone.conf
            masbr_storage_cloud_rclone_name: masbr
            masbr_storage_cloud_bucket: mas-backup
</code></pre>
<p>The following file is stored in your SCM and is a template to be injected with the credentials needed during the play. This allows the file to be stored in SCM without exposing credentials.</p>
<p>rclone.conf.j2</p>
<pre><code>[masbr]
type = s3
provider = Minio
endpoint = http://minio-api.apps.mydomain.com
access_key_id = &quot;{{ aws_access_key_id }}&quot;
secret_access_key = &quot;{{ aws_secret_access_key }}&quot;
region = minio
</code></pre>
<h2 id="troubleshooting">Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permanent link"></a></h2>
<h3 id="helpful-links">Helpful Links<a class="headerlink" href="#helpful-links" title="Permanent link"></a></h3>
<ul>
<li><a href="https://docs.redhat.com/en/documentation/red_hat_ansible_automation_platform/2.5">Red Hat AAP documentation</a></li>
<li><a href="https://docs.redhat.com/en/documentation/red_hat_ansible_automation_platform/2.5/html/installing_on_openshift_container_platform/index">Installing AAP in OCP</a></li>
<li><a href="https://docs.redhat.com/en/documentation/red_hat_ansible_automation_platform/2.5#Installing">Other install methods of AAP</a></li>
<li><a href="https://access.redhat.com/support/articles/ansible-automation-platform-certified-content">AAP Certified Content</a></li>
</ul>
<h3 id="cant-see-all-output-in-log-file">Can't see all output in log file<a class="headerlink" href="#cant-see-all-output-in-log-file" title="Permanent link"></a></h3>
<p>The output for the job doesn't output all the data in the standard view. To see the expanded data you must click on the entry to see the details and then select JSON:</p>
<p><img alt="logs-1" src="../images/logs-1.png" /></p>
<p><img alt="logs-2" src="../images/logs-2.png" /></p>
<h3 id="my-playbook-or-updated-playbook-cant-be-found">My playbook or updated playbook can't be found<a class="headerlink" href="#my-playbook-or-updated-playbook-cant-be-found" title="Permanent link"></a></h3>
<p>If you have updated your Playbook in your SCM but it is not reflected in AAP then you can sync the Project. Navigate to the Project view and click the <code>sync</code> icon so the Project gets the latest revision.</p>
<p><img alt="sync" src="../images/sync.png" /></p>
<h3 id="job-failed-can-i-re-launch-it">Job failed can I re-launch it?<a class="headerlink" href="#job-failed-can-i-re-launch-it" title="Permanent link"></a></h3>
<p>If the job fails and you want to relaunch with the same variables (from both hosts and survey), then you can re-launch the job from the Job page or the Jobs list page</p>
<p><img alt="relaunch" src="../images/relaunch.png" /></p>
<h3 id="how-to-provide-supporting-files">How to provide supporting files?<a class="headerlink" href="#how-to-provide-supporting-files" title="Permanent link"></a></h3>
<p>If you have a file that is not a playbook but you want to reference it, then you can include this in the same repo as your playbooks as AAP will be syncing the whole repo. You can then reference these files from your playbook or roles, using a pth relative to the playbook being run. An exmaple of this is the entitlement_file which can be contained in your repo:</p>
<p><img alt="files" src="../images/files.png" /></p>
<p>and then referenced in your playbook in the path <code>"license_file/entitlement.lic"</code>:</p>
<pre><code class="language-yaml">---
- hosts: localhost
  any_errors_fatal: true
  vars:
    mas_config_dir: &quot;/tmp&quot;
    mongodb_namespace: &quot;mongoce&quot;
    sls_mongodb_cfg_file: &quot;{{ mas_config_dir }}/mongo-{{ mongodb_namespace }}.yml&quot;
    entitlement_file: &quot;license_file/entitlement.lic&quot;
  roles:
    - ibm.mas_devops.mongodb
    - ibm.mas_devops.sls
</code></pre>
<h3 id="how-do-i-set-environment-variables">How do I set environment variables?<a class="headerlink" href="#how-do-i-set-environment-variables" title="Permanent link"></a></h3>
<p>Running in AAP means you can't set environment variables on the ansible controller before a playbook is executed. If a role in the <code>ibm.mas_devops</code> collection has an environment variable to be set there is normally a corresponding ansible variable. For exmaple, in the documentation for (kafka_action)[https://ibm-mas.github.io/ansible-devops/roles/kafka/#kafka_action] in the <code>kafka</code> role it says to set the environment variable <code>KAFKA_VERSION</code>, this is just setting the ansible role varible called <code>kafka_version</code> which you can set in your playbook. With ansible predence in place, the play vars or role vars will override the default vars that use the environment variable.</p>
<p>Example setting play vars:</p>
<pre><code class="language-yaml">---
- hosts: localhost
  any_errors_fatal: true
  vars:
    kafka_version: 3.7.0
  roles:
    - ibm.mas_devops.kafka
</code></pre>
<p>Example setting role vars:</p>
<pre><code class="language-yaml">---
- hosts: localhost
  any_errors_fatal: true

  roles:
    - role: ibm.mas_devops.kafka
      vars:
        kafka_version: 3.7.0
</code></pre>
<p>One caveat to the above is the <code>backup/restore</code> tasks as these use a combination of ansible vars and expecting environment variables to be set in the <code>ansible_env</code> variable. In order to work with <code>the backup/restore</code> tasks you need to set both <code>environment</code> and role/task vars (not play vars). </p>
<p>Example, showing <code>environment</code> and task vars set. See <a href="#examples-of-playbooks">backup exmaple</a> for more complete play:</p>
<pre><code class="language-yaml">- name: &quot;Backup/Restore MAS Core&quot;
  hosts: localhost
  any_errors_fatal: true

  vars:
    # Configure path to backup_restore tasks
    role_path: &quot;/usr/share/ansible/collections/ansible_collections/ibm/mas_devops/roles/suite_backup_restore&quot;

  # Set here to get into ansible_env
  environment:
    MASBR_STORAGE_TYPE: cloud
    MASBR_STORAGE_CLOUD_RCLONE_FILE: rclone.conf
    MASBR_STORAGE_CLOUD_RCLONE_NAME: masbr
    MASBR_STORAGE_CLOUD_BUCKET: mas-backup

  tasks:

    # Common checks before run tasks
    # -------------------------------------------------------------------------
    - name: &quot;Before run tasks&quot;
      include_tasks:
        file: &quot;{{ role_path }}/../../common_tasks/backup_restore/before_run_tasks.yml&quot;
      vars:
        _job_type: &quot;{{ masbr_action }}&quot;
        masbr_storage_type: cloud
        masbr_storage_cloud_rclone_file: rclone.conf
        masbr_storage_cloud_rclone_name: masbr
        masbr_storage_cloud_bucket: mas-backup
</code></pre>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/ibm-mas/ansible-devops" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href=".." style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../playbooks/ocp/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
